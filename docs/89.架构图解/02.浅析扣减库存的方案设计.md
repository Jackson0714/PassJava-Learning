# 浅析「扣减库存」的方案设计

你好，我是悟空。

上篇谈到了秒杀设计的方案《》

今天我们来探讨下`扣减库存`的方案。

生活中，我们总是用各种电商 APP 抢购商品，但是库存数是很少的，特别是秒杀场景，商品可能就一件，那如何保证不会出现超卖的情况呢？

## 一、扣减库存的三种方案

### 1.1 下单减库存

![](http://cdn.jayh.club/uPic/image-20210609165733805.png)

用户下单时减库存

**优点**：实时减库存，避免付款时因库存不足减库存的问题

**缺点**：恶意买家大量下单，将库存用完，但是不付款，真正想买的人买不到

### 1.2 付款减库存

![image-20210609165808027](http://cdn.jayh.club/uPic/image-20210609165808027.png)

下单页面显示最新的库存，下单时不会立即减库存，而是等到支付时才会减库存。

**优点**：防止恶意买家大量下单用光库存，避免下单减库存的缺点

**缺点**：下单页面显示的库存数可能不是最新的库存数，而库存数用完后，下单页面的库存数没有刷新，出现下单数超过库存数，若支付的订单数超过库存数，则会出现支付失败。

### 1.3 预扣库存

![](http://cdn.jayh.club/uPic/image-20210609165902284.png)

下单页面显示最新的库存，下单后保留这个库存一段时间（比如10分钟），超过保留时间后，库存释放。若保留时间过后再支付，如果没有库存，则支付失败。

**优点**：结合下单减库存的优点，实时减库存，且缓解恶意买家大量下单的问题，保留时间内未支付，则释放库存。

**缺点**：保留时间内，恶意买家大量下单将库存用完。并发量很高的时候，依然会出现下单数超过库存数。

## 二、如何解决恶意买家下单的问题

这里的恶意买家指短时间内大量下单，将库存用完的买家。

### 2.1 限制用户下单数量

![](http://cdn.jayh.club/uPic/image-20210609173705786.png)

**优点**：限制恶意买家下单

**缺点**：用户想要多买几件，被限制了，会降低销售量

### 2.2 标识恶意买家

![](http://cdn.jayh.club/uPic/image-20210609175159719.png)



通过标识用户的设备 id 或者会员 id，将用户加入黑名单，不足之处是有些用户是模拟的，识别不出来是不是真正的恶意买家。

## 三、如何解决下单成功而支付失败（库存不足）的问题

### 3.1 备用库存

商品库存用完后，如果还有用户支付，直接扣减备用库存。

![](http://cdn.jayh.club/uPic/image-20210609175528639.png)

**优点**：缓解部分用户支付失败的问题。

**缺点**：备用库存只能缓解问题，不能从根本上解决问题。另外备用库存针对普通商品可以，针对特殊商品这种库存少的，备用库存量也不会很大，还是会出现大量用户下单成功却因库存不足而支付失败的问题。

## 四、如何解决高并发下库存超卖的场景

库存超卖最简单的解释就是多成交了订单而发不了货。

### 场景

> 用户 A 和 B 成功下单，在支付时扣减库存，当前库存数为 10。因 A 和 B 查询库存时，都还有库存数，所以 A 和 B 都可以付款。

A 和 B 同时支付，A 和 B 支付完成后，可以看做两个请求`回调`后台系统扣减库存，有两个线程处理请求，两个线程查询出来的库存数 `inventory = 10`。

![](http://cdn.jayh.club/uPic/image-20210609180521360.png)

然后 A 线程更新最终库存数 lastInventory = inventory - 1 = 9，

B 线程更新库存数 lastInventory = inventory - 1 = 9。

而实际最终的库存应是 8 才对，这样就出现库存超卖的情况，而发不出货。

**那如何解决库存超卖的情况呢？**以下方案都是基于数据库层面的。有些同学可能会问，是不是可以用 Redis 分布式锁来，后面会讲到。

### 方案一

SQL语句直接更新库存，而不是先查询出来，然后赋值

```mysql
UPDATE [库存表] SET 库存数 - 1
```

### 方案二

SQL语句更新库存时，如果扣减库存后，库存数为负数，直接抛异常，利用事务的原子性进行自动回滚。

### 方案三

利用SQL语句更新库存，防止库存为负数

```mysql
UPDATE [库存表] SET 库存数 - 1 WHERE 库存数 - 1 > 0
```

如果影响条数大于1，则表示扣减库存成功，否则不更新库存，并退款。

## 五、秒杀场景下如何扣减库存

### 5.1 采用下单减库存

因秒杀场景下，大部分用户都是想直接购买商品的，可以直接用下单减库存。

大量用户和恶意用户都是同时进行的，区别是正常用户会直接购买商品，恶意用户虽然在竞争抢购的名额，但是获取到的资格和普通用户一样，所以下单减库存在秒杀场景下，恶意用户下单并不能造成之前说的缺点。

而且下单直接扣减库存，这个方案更简单，在第一步就扣减库存了。

### 5.2  Redis 缓存

查询缓存要比查询数据库快，所以将库存数放在缓存中，直接在缓存中扣减库存。

如果并发很高，还可以采取分布式锁的方案。分布式锁可以参考我之前写的两篇文章：

[《分布式锁1》](http://passjava.cn/#/02.PassJava%E6%9E%B6%E6%9E%84%E7%AF%87/22.%E7%BC%93%E5%AD%98%E5%AE%9E%E6%88%98%EF%BC%88%E4%BA%8C%EF%BC%89Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81)

[《分布式锁2》](http://passjava.cn/#/02.PassJava%E6%9E%B6%E6%9E%84%E7%AF%87/23.%E7%BC%93%E5%AD%98%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%89%EF%BC%89Redisson%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81)

### 5.3 限流

秒杀场景中，对请求做了很多限流操作，比如前端页面的限流和后端令牌桶限流，真正到扣减库存那一步时，请求数很少了。所以限流常用在秒杀方案中。

另外其实真实的项目中，用到了更多的机制来保证能够正常扣减库存，本篇是抛砖引入，希望大家提出宝贵的建议和方案～。

赠送一张秒杀场景方案总结：

![](http://cdn.jayh.club/uPic/image-20210609181020692.png)

