# 为什么要“除夕”，原来是内存爆了

> 传说古代有一只四角四足的怪兽：名叫`夕`。因冬天大雪导致夕没东西吃，所以夕经常到附近的村里找吃的，因其身体庞大、脾气暴躁、凶猛异常，给村民带来了很大的灾难。
>
> 后来有一位聪明的孩子，他叫做`年`，教给大家除掉“夕”的方法：用爆竹，轻则赶走它，重则伤它。每年`腊月三十`，夕都会来村里，村名就`守着夜`，放着鞭炮赶走夕。`除夕`由此而来。

我们把“夕”想象成一个不断吃机器内存的 Java 程序，就称它为 `年兽`吧。掌管 Java 虚拟机内存的就是“年”，我们称它为`年哥`吧。

## 年哥的地盘

`年哥`管理的地盘主要分为五大区：堆、方法区、虚拟机栈、本地方法栈、程序计数器。大家可以把图上的线程想象成村民，而堆是作为村民共享使用的区域。

如下图所示：

![运行时数据区](https://img-blog.csdnimg.cn/img_convert/64bfb0ffd1cf299c3cf750b317ceb604.png)

堆又可以进行细分，分为`新生代`和`老年代`，新生代和老年代的比例是 1:2，而新生代又可以进行细分，分为伊甸园（Eden）区和两个 `Survivor`， 其中 `Eden` 区大小和 `Survivor` 区大小是 8:1。

如下图所示，年兽和村民都是`共享`堆内存这块地盘的，管理员年哥是管理堆内存的。其中的数字 1、8、20 分别代表占用内存的份数。

![共享堆区](https://img-blog.csdnimg.cn/img_convert/7255bec0d25b2010e2227238e9f7b43f.png)

## 年兽的胃口

年兽的胃口是村民的几百倍，年兽假扮村名逃过了管理员年哥的检查，年哥对于这种大胃王都是直接分配到`老年代`去的，因为大胃王需要连续的内存给它吃，而新生代的碎片比较多不满足条件。在 Java 的世界中，最典型的大胃王就是大对象：如很长的字符串，或者元素数量很庞大的数组。

如下图所示，村民分配到新生代吃内存，年兽被直接分配到老年代。

![年兽被直接分配到老年代](https://img-blog.csdnimg.cn/img_convert/12e3349c1a9f41b77c0de9323382e8b0.png)

## 大量年兽入侵

年兽尝到甜头后，就开始不断地呼叫它的亲戚朋友，大量年兽被分配到了老年代，直接导致老年代的内存空间不足了，如下图所示：

![大量年兽入侵](https://img-blog.csdnimg.cn/img_convert/5669ed6dfb61dcec34924a5859caed84.png)

### 代码演示

我们用代码来演示下年兽入侵：

- 创建了 3 个年兽，都占用 10 MB 内存。

```java
public class SpringFestivalOOM {
    public static void main(String[] args) {
        // 年兽1/2/3，都占用 10 MB 内存
        byte[] nianShou1 = new byte[10 * 1024 * 1024];
        byte[] nianShou2 = new byte[10 * 1024 * 1024];
        byte[] nianShou3 = new byte[10 * 1024 * 1024];
    }
}
```

- 编译这段程序。

```sh
javac SpringFestivalOOM.java
```

- 执行这段程序，同时设置堆内存最大为 20 MB。

```sh
java -Xms20M -Xmx20M SpringFestivalOOM
```

因为 3 个年兽占用的内存 30 MB 大于堆的最大内存 20 MB，所以抛出堆内存溢出异常，如下图所示：

![堆内存溢出异常](https://img-blog.csdnimg.cn/img_convert/4f0b198fc2adafa9cef9a4172d6f378f.png)

这个时候年哥和村民才发现，原来有这么多年兽占了我们的地盘，赶快消灭它们！

## 打走年兽

村民们和年哥凑到一块，讨论了下该如何解决这个问题，究其原因就是年兽太多了，要减少他们呼朋唤友来吃内存。

放到我们的 Java 世界中，就是**减少大对象的频繁创建**。

我们程序员经常出现本地写完代码后没什么问题，到线上后就出问题，很可能的原因就是线上环境的数据量大，很容易出现大对象的频繁创建，比如大型促销活动时，`短时间`内需要创建大量订单数据，而订单数据又比较复杂，有很多字段，可能会占用大量的内存空间，最终导致`频繁触发垃圾回收`，而垃圾回收时间又会出现 `Stop the world` 现象，应用程序的性能就降下来了。

## 守岁

在除夕晚上，都会进行“守岁”，村民们齐聚一堂吃着年夜饭，一起等待除夕的钟声。等到天亮再拜访亲戚邻居。

而守岁这个过程只能待在家里，不能做其他事情，所以可以看成是垃圾回收时，其他线程不能工作，也就是 Stop the world 的由来。

如下图所示，除夕之前，村民可以去其他地方活动，除夕夜就只能待在家里守岁了，到了第二天早上就可以串门拜年了。

![mark](https://img-blog.csdnimg.cn/img_convert/2eb00251454324fc3ca0c400b1e95d5e.png)

## 总结

本篇通过除夕的故事来讲解 Java 中垃圾回收机制，因故事较为简单，所以并没有对垃圾回收算法进行深入讲解，本篇只能算作垃圾回收的入门，希望能给大家带来一定启发作用，对 JVM 很熟的同学就当学习下除夕的来历吧~

- 村民作为小对象使用堆区的`新生代`，年兽作为大对象直接使用堆区的`老年代`。
- 除夕当晚，大量`年兽入侵`老年代，导致`堆区内存不足`，触发`垃圾回收`机制。
- 守岁就是待在家里守着过新年，而垃圾回收时，`又会停止其他线程`，也就是 Stop the world。
- 避免代码中`频繁复制或创建`大对象是必须做的事情，以免上线后出现问题。
- 除夕也代表着`辞旧迎新`，这不正是执行垃圾回收吗？

> 悟空在这里预估大家除夕快乐，新年快乐，2021 心想事成，好事成双~