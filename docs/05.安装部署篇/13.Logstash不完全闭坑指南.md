# Logstash 不完全闭坑指南

你好，我是悟空呀，赛亚人又和小伙伴们见面了~

上次我们聊到了 ELK Stack 的搭建，最近悟空正在我们的测试环境部署这一套 ELK，发现还是有很多内容需要再单独拎几篇出来详细讲讲的，这次我会带着大家一起来看下 ELK 中的 Logstash 组件的落地玩法和踩坑之路。



## Logstash 用来做什么？







## Logstash 的原理

Logstash 配置文件有两个必需元素，输入（inputs）和输出（ouputs），以及一个可选元素 filters。 输入插件配置来源数据，过滤器插件在你指定时修改数据，输出插件将数据写入目标。

> 图需要重新画

![](http://cdn.jayh.club/uPic/image-20220428143451668X0cdCb.png)

我们首先需要创建一个配置文件，配置内容如下图所示：

![](http://cdn.jayh.club/uPic/image-20220428162630243dSLSIZ.png)







## Logstash 怎么跑起来的

Logstash 其实是一个 Java 应用程序，我们用 java 命令就可以启动 logstash 程序。

我们一般不会自己去用 java 命令来启动 logstash，我们只需要按照 Logstash 官方告诉我们的启动方式就可以了，比如：

```SH
cd /home/logstash-7.6.2/bin/

logstash -f weblog.conf
```

那么这个 





![image-20220527171319854](D:/_workspace/wh-docs/images/image-20220527171319854.png)





## Logstash 配置详解





## Logstash 

## 五、添加到开机启动项中

建立rc-local.service文件

``` SH
sudo vim /etc/systemd/system/rc-local.service
```

将下列内容复制进 rc-local.service 文件

``` SH
[Unit]
Description=/etc/rc.local Compatibility
ConditionPathExists=/etc/rc.local
 
[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
StandardOutput=tty
RemainAfterExit=yes
SysVStartPriority=99
 
[Install]
WantedBy=multi-user.target
```

创建文件 rc.local

``` SH
sudo vim /etc/rc.local
```

添加启动脚本到启动文件中

``` SH
#!/bin/sh -e
#
# rc.local
#
# This script is executed at the end of each multiuser runlevel.
# Make sure that the script will "exit 0" on success or any other
# value on error.
#
# In order to enable or disable this script just change the execution
# bits.
#
# By default this script does nothing.

# 启动 logstash
#nohup /home/software/logstash-7.6.2/bin/logstash -f /home/software/logstash-7.6.2/weblog.conf &

# 启动 filebeat
nohup /home/software/filebeat-7.6.2-linux-x86_64/filebeat -e -c /home/software/filebeat-7.6.2-linux-x86_64/config.yml &

exit 0
```

因在开机启动中，logstash 找不到 java 的运行环境，所以需要手动配置下 logstash。

``` SH
cd /home/software/logstash-7.6.2/bin/
sudo vim logstash.lib.sh

```

在 setup_java() 方法的第一行加入 JAVA_HOME 变量，JAVA_HOME 的路径需要根据自己的 java 安装目录来。

``` SH
JAVA_HOME="/opt/java/jdk1.8.0_181"
```

![](D:/_workspace/wh-docs/images/image-20220527134749917.png)





给 rc.local 加上权限,启用服务

``` SH
sudo chmod +x /etc/rc.local
sudo systemctl enable rc-local
sudo systemctl stop rc-local.service
sudo systemctl start rc-local.service
sudo systemctl status rc-local.service
```

权限问题的解决方案 https://www.elastic.co/guide/en/beats/libbeat/current/config-file-permissions.html





启动 Logstash

```sh
nohup bin/logstash -f weblog.conf &
# 查看logstash进程是否开启
ps -ef | grep logstash
```

再运行 Filebeat， -c 表示运行指定的配置文件，这里是 config.yml。

```SH
#控制台方式启动
/home/software/logstash-7.6.2/bin/logstash -f /home/software/logstash-7.6.2/weblog.conf &

#守护进程方式启动
nohup /home/software/filebeat-7.6.2-linux-x86_64/filebeat -e -c /home/software/filebeat-7.6.2-linux-x86_64/config.yml &
```

## 



