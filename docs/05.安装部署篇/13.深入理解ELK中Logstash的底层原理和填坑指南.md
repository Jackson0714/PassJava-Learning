## ğŸŒŸæ·±å…¥ç†è§£ ELK ä¸­ Logstash çš„åº•å±‚åŸç† + å¡«å‘æŒ‡å—

> åŸæ–‡é¦–å‘ï¼š[æ·±å…¥ç†è§£ ELK ä¸­ Logstash çš„åº•å±‚åŸç† + å¡«å‘æŒ‡å—](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451963107&idx=1&sn=22df0b863365b5a0e1b5eab2bf5ce5a6&chksm=8d1c057cba6b8c6a8783282a470ae1c67262a5b6983ca38f4c17420a0eab728fe364d2a1557e&token=1655774028&lang=zh_CN#rd)
>
> å…¬ä¼—å·ï¼šæ‚Ÿç©ºèŠæ¶æ„
>
> ä½œè€…ï¼šæ‚Ÿç©ºå“¥
>
> æ—¥æœŸï¼š2022-06-01

![img](http://cdn.jayh.club/uPic/6404LCOxp.jpeg)

è¿™æ˜¯æ‚Ÿç©ºçš„ç¬¬ 149 ç¯‡åŸåˆ›æ–‡ç« 

å®˜ç½‘ï¼š[http://www.passjava.cn](http://www.passjava.cn)

ä½ å¥½ï¼Œæˆ‘æ˜¯æ‚Ÿç©ºå‘€ï¼Œæˆ‘è¢«æ†§æ†¬å°å“¥å‚¬æ›´äº†ã€‚

å„¿ç«¥èŠ‚ã€ç«¯åˆèŠ‚å‰å‘ä¸€ç¯‡ï¼Œç¥å¤§å®¶åŒèŠ‚å¿«ä¹~

æœ¬æ–‡ç›®å½•å¦‚ä¸‹ï¼š

- å‰è¨€

- ä¸€ã€éƒ¨ç½²æ¶æ„å›¾

- äºŒã€Logstash ç”¨æ¥åšä»€ä¹ˆï¼Ÿ

- ä¸‰ã€Logstash çš„åŸç†

- - 3.1 ä» Logstash è‡ªå¸¦çš„é…ç½®è¯´èµ·
  - 3.2 Input æ’ä»¶
  - 3.3 Filter æ’ä»¶
  - 3.4 Output æ’ä»¶
  - 3.5 å®Œæ•´é…ç½®

- å››ã€Logstash æ€ä¹ˆè·‘èµ·æ¥çš„

- - 4.1 Logstash å¦‚ä½•è¿è¡Œçš„
  - 4.2 Logstash çš„æ¶æ„åŸç†

- äº”ã€Logstash å®•æœºé£é™©

- - 5.1 Logstash å•ç‚¹éƒ¨ç½²çš„é£é™©
  - 5.2 å¼€æœºå¯åŠ¨ Logstash

- å…­ã€æ€»ç»“

## å‰è¨€

é€šè¿‡æœ¬ç¯‡å†…å®¹ï¼Œä½ å¯ä»¥å­¦åˆ°å¦‚ä½•è§£å†³ Logstash çš„å¸¸è§é—®é¢˜ã€ç†è§£ Logstash çš„è¿è¡Œæœºåˆ¶ã€é›†ç¾¤ç¯å¢ƒä¸‹å¦‚ä½•éƒ¨ç½² ELK Stackã€‚

åœ¨ä½¿ç”¨ Logstash é‡åˆ°äº†å¾ˆå¤šå‘ï¼Œæœ¬ç¯‡ä¹Ÿä¼šè®²è§£è§£å†³æ–¹æ¡ˆã€‚

- æ—¥å¿—è®°å½•çš„æ ¼å¼å¤æ‚ï¼Œæ­£åˆ™è¡¨è¾¾å¼éå¸¸ç£¨äººã€‚
- æœåŠ¡æ—¥å¿—æœ‰å¤šç§æ ¼å¼ï¼Œå¦‚ä½•åŒ¹é…ã€‚
- é”™è¯¯æ—¥å¿—æ‰“å°äº†å †æ ˆä¿¡æ¯ï¼ŒåŒ…å«å¾ˆå¤šè¡Œï¼Œå¦‚ä½•åˆå¹¶ã€‚
- æ—¥å¿—è®°å½•è¡Œæ•°è¿‡å¤šï¼ˆ100 å¤šè¡Œï¼‰ï¼Œè¢«æ‹†åˆ†åˆ°äº†å…¶ä»–çš„æ—¥å¿—è®°å½•ä¸­ã€‚
- è¾“å‡ºåˆ° ES çš„æ—¥å¿—åŒ…å«å¾ˆå¤šæ— æ„ä¹‰å­—æ®µã€‚
- è¾“å‡ºåˆ° ES çš„æ—¥å¿—æ—¶é—´å’Œæœ¬æ¥çš„æ—¥å¿—æ—¶é—´ç›¸å·® 8 å°æ—¶ã€‚
- å¦‚ä½•ä¼˜åŒ– Logstash çš„æ€§èƒ½
- Logstash å•ç‚¹æ•…éšœå¦‚ä½•å¤„ç†ã€‚

## ä¸€ã€éƒ¨ç½²æ¶æ„å›¾

ä¸Šæ¬¡æˆ‘ä»¬èŠåˆ°äº† ELK Stack çš„æ­å»ºï¼š

[ä¸€æ–‡å¸¦ä½ æ­å»ºä¸€å¥— ELK Stack æ—¥å¿—å¹³å°](http://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451962693&idx=1&sn=96530613aaadd8240d8a5c2ab7dff49d&chksm=8d1c02daba6b8bcc2499861fd37aac5cfa88d616fc839cb6a7a3c003118457ac325c3dcbeb62&scene=21#wechat_redirect)

æœ€è¿‘æ‚Ÿç©ºæ­£åœ¨æˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒéƒ¨ç½²è¿™ä¸€å¥— ELKï¼Œå‘ç°è¿˜æ˜¯æœ‰å¾ˆå¤šå†…å®¹éœ€è¦å†å•ç‹¬æ‹å‡ ç¯‡å‡ºæ¥è¯¦ç»†è®²è®²çš„ï¼Œè¿™æ¬¡æˆ‘ä¼šå¸¦ç€å¤§å®¶ä¸€èµ·æ¥çœ‹ä¸‹ ELK ä¸­çš„ Logstash ç»„ä»¶çš„è½åœ°ç©æ³•å’Œè¸©å‘ä¹‹è·¯ã€‚

æµ‹è¯•ç¯å¢ƒç›®å‰æœ‰ 12 å°æœºå™¨ï¼Œå…¶ä¸­ æœ‰ 4 å°ç»™åç«¯å¾®æœåŠ¡ã€Filebeatã€Logstash ä½¿ç”¨ï¼Œ3 å°ç»™ ES é›†ç¾¤å’Œ Kibana ä½¿ç”¨ã€‚

éƒ¨ç½²æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š

![img](http://cdn.jayh.club/uPic/640m4cRML.png)



éƒ¨ç½²è¯´æ˜ï¼š

- 4 å°æœåŠ¡å™¨ç»™ä¸šåŠ¡å¾®æœåŠ¡æœåŠ¡ä½¿ç”¨ï¼Œå¾®æœåŠ¡çš„æ—¥å¿—ä¼šå­˜æ”¾æœ¬æœºä¸Šã€‚
- 4 å°æœåŠ¡å™¨éƒ½å®‰è£… Filebeat æ—¥å¿—é‡‡é›†å™¨ï¼Œé‡‡é›†æœ¬æœºçš„å¾®æœåŠ¡æ—¥å¿—ï¼Œ
- å…¶ä¸­ä¸€å°æœåŠ¡å™¨å®‰è£… Logstash ï¼ŒFilebeat å‘é€æ—¥å¿—ç»™ Logstashã€‚Logstash å°†æ—¥å¿—è¾“å‡ºåˆ° Elasticsearch é›†ç¾¤ä¸­ã€‚
- 3 å°æœåŠ¡å™¨éƒ½å®‰è£…æœ‰ Elasticsearch æœåŠ¡ï¼Œç»„æˆ ES é›†ç¾¤ã€‚å…¶ä¸­ä¸€å°å®‰è£… Kibana æœåŠ¡ï¼ŒæŸ¥è¯¢ ES é›†ç¾¤ä¸­çš„æ—¥å¿—ä¿¡æ¯ã€‚

## äºŒã€Logstash ç”¨æ¥åšä»€ä¹ˆï¼Ÿ

ä½ æ˜¯å¦è¿˜åœ¨è‹¦æ¼æ¯æ¬¡ç”Ÿäº§ç¯å¢ƒå‡ºç°é—®é¢˜éƒ½éœ€è¦è¿œç¨‹åˆ°æœåŠ¡å™¨æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼Ÿ

ä½ æ˜¯å¦è¿˜åœ¨ä¸ºäº†æ²¡æœ‰ç»Ÿä¸€çš„æ—¥å¿—æœç´¢å…¥å£è€Œçƒ¦å¿ƒï¼Ÿ

ä½ æ˜¯å¦è¿˜åœ¨ä¸ºä»å‡ åä¸‡æ¡æ—¥å¿—ä¸­æœç´¢å…³é”®ä¿¡æ¯è€Œè‹¦æ¼ï¼Ÿ

æ²¡é”™ï¼ŒLogstash å®ƒæ¥å•¦ï¼Œå¸¦ç€æ‰€æœ‰çš„æ—¥å¿—è®°å½•æ¥å•¦ã€‚

Logstash å®ƒæ˜¯å¸®åŠ©æˆ‘ä»¬æ”¶é›†ã€è§£æå’Œè½¬æ¢æ—¥å¿—çš„ã€‚ä½œä¸º ELK ä¸­çš„ä¸€å‘˜ï¼Œå‘æŒ¥ç€å¾ˆå¤§çš„ä½œç”¨ã€‚

å½“ç„¶ Logstash ä¸ä»…ä»…ç”¨åœ¨æ”¶é›†æ—¥å¿—æ–¹é¢ï¼Œè¿˜å¯ä»¥æ”¶é›†å…¶ä»–å†…å®¹ï¼Œæˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„è¿˜æ˜¯ç”¨åœ¨æ—¥å¿—æ–¹é¢ã€‚

## ä¸‰ã€Logstash çš„åŸç†

### 3.1 ä» Logstash è‡ªå¸¦çš„é…ç½®è¯´èµ·

Logstash çš„åŸç†å…¶å®è¿˜æ¯”è¾ƒç®€å•ï¼Œä¸€ä¸ªè¾“å…¥ï¼Œä¸€ä¸ªè¾“å‡ºï¼Œä¸­é—´æœ‰ä¸ªç®¡é“ï¼ˆä¸æ˜¯å¿…é¡»çš„ï¼‰ï¼Œè¿™ä¸ªç®¡é“ç”¨æ¥æ”¶é›†ã€è§£æå’Œè½¬æ¢æ—¥å¿—çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://cdn.jayh.club/uPic/640-20220601205340346RF55Yc.png)

Logstash ç»„ä»¶

Logstash è¿è¡Œæ—¶ï¼Œä¼šè¯»å– Logstash çš„é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶å¯ä»¥é…ç½®è¾“å…¥æºã€è¾“å‡ºæºã€ä»¥åŠå¦‚ä½•è§£æå’Œè½¬æ¢çš„ã€‚

Logstash é…ç½®é¡¹ä¸­æœ‰ä¸¤ä¸ªå¿…éœ€å…ƒç´ ï¼Œè¾“å…¥ï¼ˆinputsï¼‰å’Œè¾“å‡ºï¼ˆouputsï¼‰ï¼Œä»¥åŠä¸€ä¸ªå¯é€‰å…ƒç´  filters è¿‡æ»¤å™¨æ’ä»¶ã€‚input å¯ä»¥é…ç½®æ¥æºæ•°æ®ï¼Œè¿‡æ»¤å™¨æ’ä»¶åœ¨ä½ æŒ‡å®šæ—¶ä¿®æ”¹æ•°æ®ï¼Œoutput å°†æ•°æ®å†™å…¥ç›®æ ‡ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸‹ Logstash è½¯ä»¶è‡ªå¸¦çš„ä¸€ä¸ªç¤ºä¾‹é…ç½®ï¼Œæ–‡ä»¶è·¯å¾„ï¼š\logstash-7.6.2\config\logstash-sample.conf

![img](http://cdn.jayh.club/uPic/640-20220601205340387HbiqyS.png)

æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Œä¸€ä¸ª input å’Œ ä¸€ä¸ª output å°±æå®šäº†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://cdn.jayh.club/uPic/640-20220601205340428sQ9TSe.png)

ä½†æ˜¯è¿™ç§é…ç½®å…¶å®æ„ä¹‰ä¸å¤§ï¼Œæ²¡æœ‰å¯¹æ—¥å¿—è¿›è¡Œè§£æï¼Œä¼ åˆ° ES ä¸­çš„æ•°æ®æ˜¯åŸå§‹æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª message å­—æ®µåŒ…å«ä¸€æ•´æ¡æ—¥å¿—ä¿¡æ¯ï¼Œä¸ä¾¿äºæ ¹æ®å­—æ®µæœç´¢ã€‚

### 3.2 Input æ’ä»¶

é…ç½®æ–‡ä»¶ä¸­ input è¾“å…¥æºæŒ‡å®šäº† beatsï¼Œè€Œ beats æ˜¯ä¸€ä¸ªå¤§å®¶æ—ï¼ŒFilebeat åªæ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚å¯¹åº”çš„ç«¯å£ port = 5044ï¼Œè¡¨ç¤º beats æ’ä»¶å¯ä»¥å¾€ 5044 ç«¯å£å‘é€æ—¥å¿—ï¼Œlogstash å¯ä»¥æ¥æ”¶åˆ°é€šè¿‡è¿™ä¸ªç«¯å£å’Œ beats æ’ä»¶é€šä¿¡ã€‚

åœ¨éƒ¨ç½²æ¶æ„å›¾ä¸­ï¼Œinput è¾“å…¥æºæ˜¯ Filebeatï¼Œå®ƒä¸“é—¨ç›‘æ§æ—¥å¿—çš„å˜åŒ–ï¼Œç„¶åå°†æ—¥å¿—ä¼ ç»™ Logstashã€‚åœ¨æ—©æœŸï¼ŒLogstash æ˜¯è‡ªå·±æ¥é‡‡é›†çš„æ—¥å¿—æ–‡ä»¶çš„ã€‚æ‰€ä»¥æ—©æœŸçš„æ—¥å¿—æ£€ç´¢æ–¹æ¡ˆæ‰å«åš ELKï¼ŒElasticsearch + Logstash + Kibanaï¼Œè€Œç°åœ¨åŠ å…¥äº† Filebeat åï¼Œè¿™å¥—æ—¥å¿—æ£€ç´¢æ–¹æ¡ˆå±äº ELK Stackï¼Œä¸æ˜¯ ELKFï¼Œæ‘’å¼ƒäº†ç”¨é¦–å­—æ¯ç¼©å†™æ¥å‘½åã€‚

å¦å¤– input å…¶å®æœ‰å¾ˆå¤šç»„ä»¶å¯ä»¥ä½œä¸ºè¾“å…¥æºï¼Œä¸é™äº Filebeatï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç”¨ Kafka ä½œä¸ºè¾“å…¥æºï¼Œå°†æ¶ˆæ¯ä¼ ç»™ Logstashã€‚å…·ä½“æœ‰å“ªäº›æ’ä»¶åˆ—è¡¨ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ª input æ’ä»¶åˆ—è¡¨ [1]

### 3.3 Filter æ’ä»¶

è€Œå¯¹äº Logstash çš„ Filterï¼Œè¿™ä¸ªæ‰æ˜¯ Logstash æœ€å¼ºå¤§çš„åœ°æ–¹ã€‚Filter æ’ä»¶ä¹Ÿéå¸¸å¤šï¼Œæˆ‘ä»¬å¸¸ç”¨åˆ°çš„ grokã€dateã€mutateã€mutiline å››ä¸ªæ’ä»¶ã€‚

å¯¹äº filter çš„å„ä¸ªæ’ä»¶æ‰§è¡Œæµç¨‹ï¼Œå¯ä»¥çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼š

![img](http://cdn.jayh.club/uPic/640-202206012053404562FnoMx.png)

å›¾ç‰‡æ¥è‡ª Elasticsearch å®˜ç½‘

#### 3.3.1 æ—¥å¿—ç¤ºä¾‹

æˆ‘ä»¥æˆ‘ä»¬åç«¯æœåŠ¡æ‰“å°çš„æ—¥å¿—ä¸ºä¾‹ï¼Œçœ‹æ˜¯å¦‚ä½•ç”¨ filter æ’ä»¶æ¥è§£æå’Œè½¬æ¢æ—¥å¿—çš„ã€‚

logback.xml é…ç½®çš„æ—¥å¿—æ ¼å¼å¦‚ä¸‹ï¼š

```
<encoder>
    <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger - %msg%n</pattern>
</encoder>
```

æ—¥å¿—æ ¼å¼è§£é‡Šå¦‚ä¸‹ï¼š

- è®°å½•æ—¥å¿—æ—¶é—´ï¼š%d{yyyy-MM-dd HH:mm:ss.SSS}
- è®°å½•æ˜¯å“ªä¸ªçº¿ç¨‹æ‰“å°çš„æ—¥å¿—ï¼š[%thread]
- è®°å½•æ—¥å¿—ç­‰çº§ï¼š%-5level
- æ‰“å°æ—¥å¿—çš„ç±»ï¼š%logger
- è®°å½•å…·ä½“æ—¥å¿—ä¿¡æ¯ï¼š%msg%nï¼Œè¿™ä¸ª msg çš„å†…å®¹å°±æ˜¯ log.info("abc") ä¸­çš„ abcã€‚

é€šè¿‡æ‰§è¡Œä»£ç  log.info("xxx") åï¼Œå°±ä¼šåœ¨æœ¬åœ°çš„æ—¥å¿—æ–‡ä»¶ä¸­è¿½åŠ ä¸€æ¡æ—¥å¿—ã€‚

#### 3.3.2 æ‰“å°çš„æ—¥å¿—å†…å®¹

ä»æœåŠ¡å™¨æ‹·è´å‡ºäº†ä¸€æ¡æ—¥å¿—ï¼Œçœ‹ä¸‹é•¿ä»€ä¹ˆæ ·ï¼Œæœ‰éƒ¨åˆ†æ•æ„Ÿä¿¡æ¯æˆ‘å·²ç»å»æ‰äº†ã€‚

```
2022-06-16 15:50:00.070 [XNIO-1 task-1] INFO  com.passjava.config - æ–¹æ³•åä¸º:MemberController-,è¯·æ±‚å‚æ•°:{çœç•¥}
```

é‚£ä¹ˆ Logstash å¦‚ä½•é’ˆå¯¹ä¸Šé¢çš„ä¿¡æ¯è§£æå‡ºå¯¹åº”çš„å­—æ®µå‘¢ï¼Ÿæ¯”å¦‚å¦‚ä½•è§£æå‡ºæ‰“å°æ—¥å¿—çš„æ—¶é—´ã€æ—¥å¿—ç­‰çº§ã€æ—¥å¿—ä¿¡æ¯ï¼Ÿ

#### 3.3.3 grok æ’ä»¶

è¿™é‡Œå°±è¦ç”¨åˆ° logstash çš„ filter ä¸­çš„ grok æ’ä»¶ã€‚filebeat å‘é€ç»™ logstash çš„æ—¥å¿—å†…å®¹ä¼šæ”¾åˆ° message å­—æ®µé‡Œé¢ï¼Œlogstash åŒ¹é…è¿™ä¸ª message å­—æ®µå°±å¯ä»¥äº†ã€‚é…ç½®é¡¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```
filter { grok {      match => [ "message", "(?<logTime>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}.\d{3})\s+\[(?<thread>.*)\]\s+(?<level>\w*)\s{1,2}+(?<class>\S*)\s+-\s+(?<content>.*)\s*"]  }}
```

å‘ï¼šæ—¥å¿—è®°å½•çš„æ ¼å¼å¤æ‚ï¼Œæ­£åˆ™è¡¨è¾¾å¼éå¸¸ç£¨äººã€‚

å¤§å®¶å‘ç°æ²¡ï¼Œä¸Šé¢çš„ åŒ¹é… message çš„æ­£åˆ™è¡¨è¾¾å¼è¿˜æ˜¯æŒºå¤æ‚çš„ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä¸€ç‚¹ä¸€ç‚¹è¯•å‡ºæ¥çš„ã€‚Kibana è‡ªå¸¦ grok çš„æ­£åˆ™åŒ¹é…çš„å·¥å…·ï¼Œè·¯å¾„å¦‚ä¸‹ï¼š

```
http://<your kibana IP>:5601/app/kibana#/dev_tools/grokdebugger
```

æˆ‘ä»¬æŠŠæ—¥å¿—å’Œæ­£åˆ™è¡¨è¾¾å¼åˆ†åˆ«ç²˜è´´åˆ°ä¸Šé¢çš„è¾“å…¥æ¡†ï¼Œç‚¹å‡» Simulate å°±å¯ä»¥æµ‹è¯•æ˜¯å¦èƒ½æ­£ç¡®åŒ¹é…å’Œè§£æå‡ºæ—¥å¿—å­—æ®µã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://cdn.jayh.club/uPic/640-20220601205340486ygviCk.png)

Grok Debugger å·¥å…·

æœ‰æ²¡æœ‰å¸¸ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼å‘¢ï¼Ÿæœ‰çš„ï¼Œlogstash å®˜æ–¹ä¹Ÿç»™äº†ä¸€äº›å¸¸ç”¨çš„`å¸¸é‡`æ¥è¡¨è¾¾é‚£äº›æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¯ä»¥åˆ°è¿™ä¸ª Github åœ°å€æŸ¥çœ‹æœ‰å“ªäº›å¸¸ç”¨çš„å¸¸é‡ã€‚

```
https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/ecs-v1/grok-patterns
```

æ¯”å¦‚å¯ä»¥ç”¨ IP å¸¸é‡æ¥ä»£æ›¿æ­£åˆ™è¡¨è¾¾å¼ `IP (?:%{IPV6}|%{IPV4})`ã€‚

å¥½äº†ï¼Œç»è¿‡æ­£åˆ™è¡¨è¾¾å¼çš„åŒ¹é…ä¹‹åï¼Œgrok æ’ä»¶ä¼šå°†æ—¥å¿—è§£ææˆå¤šä¸ªå­—æ®µï¼Œç„¶åå°†å¤šä¸ªå­—æ®µå­˜åˆ°äº† ES ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨ ES é€šè¿‡å­—æ®µæ¥æœç´¢ï¼Œä¹Ÿå¯ä»¥åœ¨ kibana çš„ Discover ç•Œé¢æ·»åŠ åˆ—è¡¨å±•ç¤ºçš„å­—æ®µã€‚

![img](http://cdn.jayh.club/uPic/640-20220601205340514tjdLkg.png)



å‘ï¼šæˆ‘ä»¬åç«¯é¡¹ç›®çš„ä¸åŒæœåŠ¡æ‰“å°äº†ä¸¤ç§ä¸åŒæ ¼å¼çš„æ—¥å¿—ï¼Œé‚£è¿™ç§å¦‚ä½•åŒ¹é…ï¼Ÿ

å†åŠ ä¸€ä¸ª match å°±å¯ä»¥äº†ã€‚

```
filter { grok {      match => [ "message", "(?<logTime>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}.\d{3})\s+\[(?<thread>.*)\]\s+(?<level>\w*)\s{1,2}+(?<class>\S*)\s+-\s+(?<content>.*)\s*"]      match => [ "message", "(?<logTime>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}.\d{3})\s{1,2}+(?<level>\w*)\s{1,2}+.\s---+\s\[(?<thread>.*)\]+\s(?<class>\S*)\s*:+\s(?<content>.*)\s*"]  }}
```

å½“ä»»æ„ä¸€ä¸ª message åŒ¹é…ä¸Šäº†è¿™ä¸ªæ­£åˆ™ï¼Œåˆ™ grok æ‰§è¡Œå®Œæ¯•ã€‚å‡å¦‚è¿˜æœ‰ç¬¬ä¸‰ç§æ ¼å¼çš„ messageï¼Œé‚£ä¹ˆè™½ç„¶ grok æ²¡æœ‰åŒ¹é…ä¸Šï¼Œä½†æ˜¯ message ä¹Ÿä¼šè¾“å‡ºåˆ° ESï¼Œåªæ˜¯è¿™æ¡æ—¥å¿—åœ¨ ES ä¸­ä¸ä¼šå±•ç¤º logTimeã€level ç­‰å­—æ®µã€‚

#### 3.3.4 multiline æ’ä»¶

è¿˜æœ‰ä¸€ä¸ªå‘çš„åœ°æ–¹æ˜¯é”™è¯¯æ—¥å¿—ä¸€èˆ¬éƒ½æ˜¯å¾ˆå¤šè¡Œçš„ï¼Œä¼šæŠŠå †æ ˆä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œå½“ç»è¿‡ logstash è§£æåï¼Œæ¯ä¸€è¡Œéƒ½ä¼šå½“åšä¸€æ¡è®°å½•å­˜æ”¾åˆ° ESï¼Œé‚£è¿™ç§æƒ…å†µè‚¯å®šæ˜¯éœ€è¦å¤„ç†çš„ã€‚è¿™é‡Œå°±éœ€è¦ä½¿ç”¨ multiline æ’ä»¶ï¼Œå¯¹å±äºåŒä¸€ä¸ªæ¡æ—¥å¿—çš„è®°å½•è¿›è¡Œæ‹¼æ¥ã€‚

##### 3.3.4.1 å®‰è£… multiline æ’ä»¶

multiline ä¸æ˜¯ logstash è‡ªå¸¦çš„ï¼Œéœ€è¦å•ç‹¬è¿›è¡Œå®‰è£…ã€‚æˆ‘ä»¬çš„ç¯å¢ƒæ˜¯æ²¡æœ‰å¤–ç½‘çš„ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œç¦»çº¿å®‰è£…ã€‚

ä»‹ç»åœ¨çº¿å’Œç¦»çº¿å®‰è£… multiline çš„æ–¹å¼ï¼š

- åœ¨çº¿å®‰è£…æ’ä»¶ã€‚

åœ¨ logstash æ ¹ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ã€‚

```
bin/logstash-plugin install logstash-filter-multiline
```

![img](http://cdn.jayh.club/uPic/640-20220601205340538Q6974l.png)

- ç¦»çº¿å®‰è£…æ’ä»¶ã€‚

åœ¨æœ‰ç½‘çš„æœºå™¨ä¸Šåœ¨çº¿å®‰è£…æ’ä»¶ï¼Œç„¶åæ‰“åŒ…ã€‚

```
bin/logstash-plugin install logstash-filter-multiline
bin/logstash-plugin prepare-offline-pack logstash-filter-multiline
```

æ‹·è´åˆ°æœåŠ¡å™¨ï¼Œæ‰§è¡Œå®‰è£…å‘½ä»¤ã€‚

```
bin/logstash-plugin install file:///home/software/logstash-offline-plugins-7.6.2.zip
```

å®‰è£…æ’ä»¶éœ€è¦ç­‰å¾… 5 åˆ†é’Ÿå·¦å³çš„æ—¶é—´ï¼Œæ§åˆ¶å°ç•Œé¢ä¼šè¢« hang ä½ï¼Œå½“å‡ºç° `Install successful` è¡¨ç¤ºå®‰è£…æˆåŠŸã€‚

![img](http://cdn.jayh.club/uPic/640-20220601205340562yg2hnh.png)

æ£€æŸ¥ä¸‹æ’ä»¶æ˜¯å¦å®‰è£…æˆåŠŸï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ’ä»¶åˆ—è¡¨ã€‚å½“å‡ºç° multiline æ’ä»¶æ—¶åˆ™è¡¨ç¤ºå®‰è£…æˆåŠŸã€‚

```
bin/logstash-plugin list
```

##### 3.3.4.2 ä½¿ç”¨ multiline æ’ä»¶

å¦‚æœè¦å¯¹åŒä¸€æ¡æ—¥å¿—çš„å¤šè¡Œè¿›è¡Œåˆå¹¶ï¼Œä½ çš„æ€è·¯æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿæ¯”å¦‚ä¸‹é¢è¿™ä¸¤æ¡å¼‚å¸¸æ—¥å¿—ï¼Œå¦‚ä½•æŠŠæ–‡ä»¶ä¸­çš„ 8 è¡Œæ—¥å¿—åˆå¹¶æˆä¸¤æ¡æ—¥å¿—ï¼Ÿ

![img](http://cdn.jayh.club/uPic/640-20220601205340601PCH1Ir.png)

å¤šè¡Œæ—¥å¿—ç¤ºä¾‹

æ€è·¯æ˜¯è¿™æ ·çš„ï¼š

- ç¬¬ä¸€æ­¥ï¼šæ¯ä¸€æ¡æ—¥å¿—çš„ç¬¬ä¸€è¡Œå¼€å¤´éƒ½æ˜¯ä¸€ä¸ªæ—¶é—´ï¼Œå¯ä»¥ç”¨æ—¶é—´çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ°ç¬¬ä¸€è¡Œã€‚
- ç¬¬äºŒæ­¥ï¼šç„¶åå°†åé¢æ¯ä¸€è¡Œçš„æ—¥å¿—ä¸ç¬¬ä¸€è¡Œåˆå¹¶ã€‚
- ç¬¬ä¸‰æ­¥ï¼šå½“é‡åˆ°æŸä¸€è¡Œçš„å¼€å¤´æ˜¯å¯ä»¥åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„æ—¶é—´çš„ï¼Œå°±åœæ­¢ç¬¬ä¸€æ¡æ—¥å¿—çš„åˆå¹¶ï¼Œå¼€å§‹åˆå¹¶ç¬¬äºŒæ¡æ—¥å¿—ã€‚
- ç¬¬å››æ­¥ï¼šé‡å¤ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥

æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œmultiline çš„é…ç½®å¦‚ä¸‹ï¼š

```
filter {  multiline {    pattern => "^\d{4}-\d{1,2}-\d{1,2}\s\d{1,2}:\d{1,2}:\d{1,2}.\d{3}"    negate => true    what => "previous"  }}
```

æ—¶é—´çš„æ­£åˆ™è¡¨è¾¾å¼å°±æ˜¯è¿™ä¸ª pattern å­—æ®µï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±é¡¹ç›®ä¸­çš„æ—¥å¿—çš„æ—¶é—´æ¥å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼ã€‚

- pattern: è¿™ä¸ªæ˜¯ç”¨æ¥åŒ¹é…æ–‡æœ¬çš„è¡¨è¾¾å¼ï¼Œä¹Ÿå¯ä»¥æ˜¯`grok`è¡¨è¾¾å¼

- what: å¦‚æœ`pattern`åŒ¹é…æˆåŠŸçš„è¯ï¼Œé‚£ä¹ˆåŒ¹é…è¡Œæ˜¯å½’å±äºä¸Šä¸€ä¸ªäº‹ä»¶ï¼Œè¿˜æ˜¯å½’å±äºä¸‹ä¸€ä¸ªäº‹ä»¶ã€‚

  previous: å½’å±äºä¸Šä¸€ä¸ªäº‹ä»¶ï¼Œå‘ä¸Šåˆå¹¶ã€‚

  next: å½’å±äºä¸‹ä¸€ä¸ªäº‹ä»¶ï¼Œå‘ä¸‹åˆå¹¶

- negate: æ˜¯å¦å¯¹ pattern çš„ç»“æœå–å

  false: ä¸å–åï¼Œæ˜¯é»˜è®¤å€¼ã€‚

  true: å–åã€‚å°†å¤šè¡Œäº‹ä»¶æ‰«æè¿‡ç¨‹ä¸­çš„è¡ŒåŒ¹é…é€»è¾‘å–åï¼ˆå¦‚æœ pattern åŒ¹é…å¤±è´¥ï¼Œåˆ™è®¤ä¸ºå½“å‰è¡Œæ˜¯å¤šè¡Œäº‹ä»¶çš„ç»„æˆéƒ¨åˆ†ï¼‰

å‚è€ƒ multiline å®˜æ–¹æ–‡æ¡£ [2]

#### 3.3.5 å¤šè¡Œè¢«æ‹†åˆ†

å‘ï¼šJava å †æ ˆæ—¥å¿—å¤ªé•¿äº†ï¼Œæœ‰ 100 å¤šè¡Œï¼Œè¢«æ‹†åˆ†äº†ä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†è¢«åˆå¹¶åˆ°äº†åŸæ¥çš„é‚£ä¸€æ¡æ—¥å¿—ä¸­ï¼Œå¦å¤–ä¸€éƒ¨åˆ†è¢«åˆå¹¶åˆ°äº†ä¸ç›¸å…³çš„æ—¥å¿—ä¸­ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç¬¬äºŒæ¡æ—¥å¿—æœ‰ 100 å¤šè¡Œï¼Œå…¶ä¸­æœ€åä¸€è¡Œè¢«é”™è¯¯åœ°åˆå¹¶åˆ°äº†ç¬¬ä¸‰æ¡æ—¥å¿—ä¸­ã€‚

![img](http://cdn.jayh.club/uPic/640-20220601205340638qyvoqr.png)

æ—¥å¿—åˆå¹¶é”™ä¹±

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ˜¯é€šè¿‡é…ç½® filebeat çš„ multiline æ’ä»¶æ¥æˆªæ–­æ—¥å¿—çš„ã€‚ä¸ºä»€ä¹ˆä¸ç”¨ logstash çš„ multiline æ’ä»¶å‘¢ï¼Ÿå› ä¸ºåœ¨ filter ä¸­ä½¿ç”¨ multiline æ²¡æœ‰æˆªæ–­çš„é…ç½®é¡¹ã€‚filebeat çš„ multiline é…ç½®é¡¹å¦‚ä¸‹ï¼š

```
multiline.type: patternmultiline.pattern: '^\d{4}-\d{1,2}-\d{1,2}\s\d{1,2}:\d{1,2}:\d{1,2}.\d{3}'multiline.negate: truemultiline.match: aftermultiline.max_lines: 50
```

é…ç½®é¡¹è¯´æ˜ï¼š

- multiline.patternï¼šå¸Œæœ›åŒ¹é…åˆ°çš„ç»“æœï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
- multiline.negateï¼šå€¼ä¸º true æˆ– falseã€‚ä½¿ç”¨ false ä»£è¡¨åŒ¹é…åˆ°çš„è¡Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œï¼›ä½¿ç”¨ true ä»£è¡¨ä¸åŒ¹é…çš„è¡Œåˆå¹¶åˆ°ä¸Šä¸€è¡Œ
- multiline.matchï¼šå€¼ä¸º after æˆ– beforeã€‚after ä»£è¡¨åˆå¹¶åˆ°ä¸Šä¸€è¡Œçš„æœ«å°¾ï¼›before ä»£è¡¨åˆå¹¶åˆ°ä¸‹ä¸€è¡Œçš„å¼€å¤´
- multiline.max_linesï¼šåˆå¹¶çš„æœ€å¤§è¡Œæ•°ï¼Œé»˜è®¤ 500
- multiline.timeoutï¼šä¸€æ¬¡åˆå¹¶äº‹ä»¶çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 5sï¼Œé˜²æ­¢åˆå¹¶æ¶ˆè€—å¤ªå¤šæ—¶é—´å¯¼è‡´ filebeat è¿›ç¨‹å¡æ­»

æˆ‘ä»¬é‡ç‚¹å…³æ³¨ max_lines å±æ€§ï¼Œè¡¨ç¤ºæœ€å¤šä¿ç•™å¤šå°‘è¡Œåæ‰§è¡Œæˆªæ–­ï¼Œè¿™é‡Œé…ç½® 50 è¡Œã€‚

æ³¨æ„ï¼šfilebeat å’Œ logstash æˆ‘éƒ½é…ç½®äº† multilineï¼Œæ²¡æœ‰éªŒè¯è¿‡åªé…ç½® filebeat çš„æƒ…å†µã€‚å‚è€ƒ Filebeat å®˜æ–¹æ–‡æ¡£ [3]

#### 3.3.6 mutate æ’ä»¶

å½“æˆ‘ä»¬å°†æ—¥å¿—è§£æå‡ºæ¥åï¼ŒLogstash è‡ªèº«ä¼šä¼ ä¸€äº›ä¸ç›¸å…³çš„å­—æ®µåˆ° ES ä¸­ï¼Œè¿™äº›å­—æ®µå¯¹æˆ‘ä»¬æ’æŸ¥çº¿ä¸Šé—®é¢˜å¸®åŠ©ä¸å¤§ã€‚å¯ä»¥ç›´æ¥å‰”é™¤æ‰ã€‚

å‘ï¼šè¾“å‡ºåˆ° ES çš„æ—¥å¿—åŒ…å«å¾ˆå¤šæ— æ„ä¹‰å­—æ®µã€‚

è¿™é‡Œæˆ‘ä»¬å°±è¦ç”¨åˆ° mutate æ’ä»¶äº†ã€‚å®ƒå¯ä»¥å¯¹å­—æ®µè¿›è¡Œè½¬æ¢ï¼Œå‰”é™¤ç­‰ã€‚

æ¯”å¦‚æˆ‘çš„é…ç½®æ˜¯è¿™æ ·çš„ï¼Œå¯¹å¾ˆå¤šå­—æ®µè¿›è¡Œäº†å‰”é™¤ã€‚

```
mutate {    remove_field => ["agent","message","@version", "tags", "ecs", "input", "[log][offset]"]}
```

æ³¨æ„ï¼šä¸€å®šè¦æŠŠ log.offset å­—æ®µå»æ‰ï¼Œè¿™ä¸ªå­—æ®µå¯èƒ½ä¼šåŒ…å«å¾ˆå¤šæ— æ„ä¹‰å†…å®¹ã€‚

å…³äº Mutate è¿‡æ»¤å™¨å®ƒæœ‰å¾ˆå¤šé…ç½®é¡¹å¯ä¾›é€‰æ‹©ï¼Œå¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼š

![img](http://cdn.jayh.club/uPic/640-20220601205340667vMwoyr.png)

Mutate  è¿‡æ»¤å™¨é…ç½®é€‰é¡¹

å‚è€ƒ Mutate å‚è€ƒæ–‡ç«  [4]

#### 3.3.7 date æ’ä»¶

åˆ° kibana æŸ¥è¯¢æ—¥å¿—æ—¶ï¼Œå‘ç°æ’åºå’Œè¿‡æ»¤å­—æ®µ `@timestamp` æ˜¯ ES æ’å…¥æ—¥å¿—çš„æ—¶é—´ï¼Œè€Œä¸æ˜¯æ‰“å°æ—¥å¿—çš„æ—¶é—´ã€‚

è¿™é‡Œæˆ‘ä»¬å°±è¦ç”¨åˆ° `date` æ’ä»¶äº†ã€‚

ä¸Šé¢çš„ grok æ’ä»¶å·²ç»æˆåŠŸè§£æå‡ºäº†æ‰“å°æ—¥å¿—çš„æ—¶é—´ï¼Œèµ‹å€¼åˆ°äº† `logTime` å˜é‡ä¸­ï¼Œç°åœ¨ç”¨ date æ’ä»¶å°† `logTime` åŒ¹é…ä¸‹ï¼Œå¦‚æœèƒ½åŒ¹é…ï¼Œåˆ™ä¼šèµ‹å€¼åˆ° `@timestamp `å­—æ®µï¼Œå†™å…¥åˆ° ES ä¸­çš„ `@timestamp `å­—æ®µå°±ä¼šå’Œæ—¥å¿—æ—¶é—´ä¸€è‡´äº†ã€‚é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š

```
date {    match => ["logTime", "MMM d HH:mm:ss", "MMM dd HH:mm:ss", "ISO8601"]}
```

ä½†æ˜¯ç»è¿‡æµ‹è¯•å†™å…¥åˆ° ES çš„ `@timestamp` æ—¥å¿—æ—¶é—´å’Œæ‰“å°çš„æ—¥å¿—æ—¶é—´ç›¸å·® 8 å°æ—¶ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://cdn.jayh.club/uPic/640-20220601205340691AZRACo.png)

æˆ‘ä»¬åˆ° ES ä¸­æŸ¥è¯¢è®°å½•åï¼Œå‘ç° `@timestamp` å­—æ®µæ—¶é—´å¤šäº†ä¸€ä¸ªå­—æ¯ `Z`ï¼Œä»£è¡¨ `UTC` æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´ ES ä¸­å­˜çš„æ—¶é—´æ¯”æ—¥å¿—è®°å½•çš„æ—¶é—´æ™š 8 ä¸ªå°æ—¶ã€‚

![img](http://cdn.jayh.club/uPic/640-202206012053407176DUwQK.png)

æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ é…ç½®  timezone => "Asia/Shanghai" æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¿®æ”¹åçš„é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š

```
date {    match => ["logTime", "MMM d HH:mm:ss", "MMM dd HH:mm:ss", "ISO8601"]    timezone => "Asia/Shanghai"  }
```

è°ƒæ•´åï¼Œå†åŠ ä¸€æ¡æ—¥å¿—åæŸ¥çœ‹ç»“æœï¼ŒKibana æ˜¾ç¤º @timestamp å­—æ®µå’Œæ—¥å¿—çš„è®°å½•æ—¶é—´ä¸€è‡´äº†ã€‚

![img](http://cdn.jayh.club/uPic/640-20220601205340747le4ZX1.png)

### 3.4 Output æ’ä»¶

Logstash è§£æå’Œè½¬æ¢åçš„æ—¥å¿—æœ€åè¾“å‡ºåˆ°äº† Elasticsearch ä¸­ï¼Œç”±äºæˆ‘ä»¬ ES æ˜¯é›†ç¾¤éƒ¨ç½²çš„ï¼Œæ‰€ä»¥éœ€è¦é…ç½®å¤šä¸ª  ES èŠ‚ç‚¹åœ°å€ã€‚

```
output {  stdout { }  elasticsearch {    hosts => ["10.2.1.64:9200","10.2.1.65:9200","10.27.2.1:9200"]    index => "qa_log"  }}
```

æ³¨æ„è¿™é‡Œçš„ index åç§° qa_log å¿…é¡»æ˜¯å°å†™ï¼Œä¸ç„¶å†™å…¥ es æ—¶ä¼šæŠ¥é”™ã€‚

### 3.5 å®Œæ•´é…ç½®

logstah é…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```
input {  beats {    port => 9900  }}filter {  multiline {    pattern => "^\d{4}-\d{1,2}-\d{1,2}\s\d{1,2}:\d{1,2}:\d{1,2}.\d{3}"    negate => true    what => "previous"  }  grok {      match => [ "message", "(?<logTime>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}.\d{3})\s+\[(?<thread>.*)\]\s+(?<level>\w*)\s{1,2}+(?<class>\S*)\s+-\s+(?<content>.*)\s*"]      match => [ "message", "(?<logTime>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}.\d{3})\s{1,2}+(?<level>\w*)\s{1,2}+.\s---+\s\[(?<thread>.*)\]+\s(?<class>\S*)\s*:+\s(?<content>.*)\s*"]      match => [           "source", "/home/passjava/logs/(?<logName>\w+)/.*.log"       ]      overwrite => [ "source"]      break_on_match => false  }  mutate {    convert => {      "bytes" => "integer"    }    remove_field => ["agent","message","@version", "tags", "ecs", "_score", "input", "[log][offset]"]  }  useragent {    source => "user_agent"    target => "useragent"  }  date {    match => ["logTime", "MMM d HH:mm:ss", "MMM dd HH:mm:ss", "ISO8601"]    timezone => "Asia/Shanghai"  }}output {  stdout { }  elasticsearch {    hosts => ["10.2.1.64:9200","10.2.1.65:9200","10.2.1.66:9200"]    index => "qa_log"  }}
```

## å››ã€Logstash æ€ä¹ˆè·‘èµ·æ¥çš„

### 4.1 Logstash å¦‚ä½•è¿è¡Œçš„

ä½ ä¼šå¥½å¥‡ Logstash æ˜¯æ€ä¹ˆè¿è¡Œèµ·æ¥çš„å—ï¼Ÿ

å®˜æ–¹æä¾›çš„å¯åŠ¨æ–¹å¼æ˜¯æ‰§è¡Œ logstash -f weblog.conf å‘½ä»¤æ¥å¯åŠ¨ï¼Œå½“æ‰§è¡Œè¿™ä¸ªå‘½ä»¤çš„æ—¶å€™å…¶å®ä¼šè°ƒç”¨ Java å‘½ä»¤ï¼Œä»¥åŠè®¾ç½® java å¯åŠ¨å‚æ•°ï¼Œç„¶åä¼ å…¥äº†ä¸€ä¸ªé…ç½®æ–‡ä»¶ weblog.conf æ¥å¯åŠ¨ Logstashã€‚

```
cd /home/logstash-7.6.2sudo ./bin/logstash -f weblog.conf
```

å½“å¯åŠ¨å®Œä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡å‘½ä»¤æ¥çœ‹ä¸‹ Logstash çš„è¿è¡ŒçŠ¶æ€

```
ps -ef | grep logstash
```

æ‰§è¡Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°ç”¨åˆ°äº† Java å‘½ä»¤ï¼Œè®¾ç½®äº† JVM å‚æ•°ï¼Œç”¨åˆ°äº† Logstash çš„ JAR åŒ…ï¼Œä¼ å…¥äº†å‚æ•°ã€‚



![img](http://cdn.jayh.club/uPic/640-20220601205340803YT4eJF.png)

**æ‰€ä»¥å»ºè®® Logstash å•ç‹¬éƒ¨ç½²åˆ°ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œé¿å…æœåŠ¡å™¨çš„èµ„æºè¢« Logstash å ç”¨ã€‚**



Logstash é»˜è®¤çš„ JVM é…ç½®æ˜¯ -Xms1g -Xmx1gï¼Œè¡¨ç¤ºåˆ†é…çš„æœ€å°å’Œæœ€å¤§å †å†…å­˜å¤§å°ä¸º 1 Gã€‚

é‚£ä¹ˆè¿™ä¸ªå‚æ•°æ˜¯åœ¨å“ªé‡Œé…ç½®çš„å‘¢ï¼Ÿå…¨å±€æœç´¢ä¸‹ Xms1gï¼Œæ‰¾åˆ°æ˜¯åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢é…ç½®çš„ï¼Œconfig\jvm.optionsï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¿™é‡Œé¢çš„ JVM é…ç½®ã€‚

æˆ‘ä»¬å¯ä»¥è°ƒæ•´ Logstash çš„ JVM å¯åŠ¨å‚æ•°ï¼Œæ¥ä¼˜åŒ– Logstash çš„æ€§èƒ½ã€‚

å¦å¤– Kibana ä¸Šé¢è¿˜å¯ä»¥ç›‘æ§ Logstash çš„è¿è¡ŒçŠ¶æ€ï¼ˆä¸åœ¨æœ¬ç¯‡è®¨è®ºèŒƒå›´ï¼‰ã€‚

### 4.2 Logstash çš„æ¶æ„åŸç†

![img](http://cdn.jayh.club/uPic/640-20220601205340836utwCO9.png)

æœ¬å†…å®¹å‚è€ƒè¿™ç¯‡ Logstash æ¶æ„ [5]

Logstash æœ‰å¤šä¸ª inputï¼Œæ¯ä¸ª input éƒ½ä¼šæœ‰è‡ªå·±çš„ codecã€‚

æ•°æ®ä¼šå…ˆå­˜æ”¾åˆ° Queue ä¸­ï¼ŒLogstash ä¼šæŠŠ Queue ä¸­çš„æ•°æ®åˆ†å‘åˆ°ä¸åŒçš„ pipeline ä¸­ã€‚

ç„¶åæ¯ä¸€ä¸ª pipeline ç”± Batcherã€filterã€output ç»„æˆ

Batcher çš„ä½œç”¨æ˜¯æ‰¹é‡åœ°ä» Queue ä¸­å–æ•°æ®ã€‚Batcher å¯ä»¥é…ç½®ä¸ºä¸€æ¬¡å–ä¸€ç™¾ä¸ªæ•°æ®ã€‚

## äº”ã€Logstash å®•æœºé£é™©

### 5.1 Logstash å•ç‚¹éƒ¨ç½²çš„é£é™©

å› ä¸º Logstash æ˜¯å•ç‚¹éƒ¨ç½²åˆ°ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥ä¼šå­˜åœ¨ä¸¤ä¸ªé£é™©ï¼š

- logstash çªç„¶å´©äº†æ€ä¹ˆåŠï¼Ÿ
- logstash æ‰€åœ¨çš„æœºå™¨å®•æœºäº†æ€ä¹ˆåŠï¼Ÿ
- Logstash æ‰€åœ¨çš„æœºå™¨é‡å¯äº†æ€ä¹ˆåŠï¼Ÿ

å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå¯ä»¥å®‰è£… Keepalived è½¯ä»¶æ¥ä¿è¯é«˜å¯ç”¨ã€‚å¦å¤–å³ä½¿æ²¡æœ‰å®‰è£…ï¼Œå½“æ‰‹åŠ¨å¯åŠ¨ Logstash åï¼ŒLogstash ä¹Ÿèƒ½å°†æœªåŠæ—¶åŒæ­¥çš„æ—¥å¿—å†™å…¥åˆ° ESã€‚

å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œæ‰€åœ¨çš„æœºå™¨å®•æœºäº†ï¼Œé‚£å¯ä»¥é€šè¿‡å®‰è£…ä¸¤å¥— Logstashï¼Œé€šè¿‡ keepalived æä¾›çš„è™šæ‹Ÿ IP åŠŸèƒ½ï¼Œåˆ‡æ¢æµé‡åˆ°å¦å¤–ä¸€ä¸ª Logstashã€‚å…³äºå¦‚ä½•ä½¿ç”¨ Keepalivedï¼Œå¯ä»¥å‚è€ƒä¹‹å‰çš„ [å®æˆ˜ MySQL é«˜å¯ç”¨æ¶æ„](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451963004&idx=1&sn=2667d0e6e9142939e3645de680a4533f&chksm=8d1c05e3ba6b8cf5a6a0ab2ecb66af10496838e25814cbefcd45907dd652a5ec6ef3917b6ada&token=1170452569&lang=zh_CN&scene=21#wechat_redirect)

å¯¹äºç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æŠŠå¯åŠ¨ Logstash çš„å‘½ä»¤æ”¾åˆ°å¼€æœºå¯åŠ¨è„šæœ¬ä¸­å°±å¯ä»¥äº†ï¼Œä½†æ˜¯å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

- Ubuntu 18.04 ç‰ˆæœ¬æ˜¯æ²¡æœ‰å¼€æœºå¯åŠ¨æ–‡ä»¶çš„
- Logstash æ— æ³•æ‰¾åˆ° Java è¿è¡Œç¯å¢ƒ

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹æ€ä¹ˆè¿›è¡Œé…ç½®å¼€æœºè‡ªå¯åŠ¨ Logstashã€‚

### 5.2 å¼€æœºå¯åŠ¨ Logstash

#### 5.2.1 åˆ›å»ºè‡ªåŠ¨å¯åŠ¨è„šæœ¬

å»ºç«‹ rc-local.service æ–‡ä»¶

```
sudo vim /etc/systemd/system/rc-local.service
```

å°†ä¸‹åˆ—å†…å®¹å¤åˆ¶è¿› rc-local.service æ–‡ä»¶

```
[Unit]
Description=/etc/rc.local Compatibility
ConditionPathExists=/etc/rc.local
 
[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
StandardOutput=tty
RemainAfterExit=yes
SysVStartPriority=99
 
[Install]
WantedBy=multi-user.target
```

åˆ›å»ºæ–‡ä»¶ rc.local

```
sudo vim /etc/rc.local
```

æ·»åŠ å¯åŠ¨è„šæœ¬åˆ°å¯åŠ¨æ–‡ä»¶ä¸­

```
#!/bin/sh -e# å¯åŠ¨ logstash#nohup /home/software/logstash-7.6.2/bin/logstash -f /home/software/logstash-7.6.2/weblog.conf &# å¯åŠ¨ filebeatnohup /home/software/filebeat-7.6.2-linux-x86_64/filebeat -e -c /home/software/filebeat-7.6.2-linux-x86_64/config.yml &exit 0
```

#### 5.2.2 ä¿®æ”¹ Java è¿è¡Œç¯å¢ƒ

å› åœ¨å¼€æœºå¯åŠ¨ä¸­ï¼Œlogstash æ‰¾ä¸åˆ° java çš„è¿è¡Œç¯å¢ƒï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨é…ç½®ä¸‹ logstashã€‚

```
cd /home/software/logstash-7.6.2/bin/sudo vim logstash.lib.sh
```

åœ¨ setup_java() æ–¹æ³•çš„ç¬¬ä¸€è¡ŒåŠ å…¥ JAVA_HOME å˜é‡ï¼ŒJAVA_HOME çš„è·¯å¾„éœ€è¦æ ¹æ®è‡ªå·±çš„ java å®‰è£…ç›®å½•æ¥ã€‚

```
JAVA_HOME="/opt/java/jdk1.8.0_181"
```

![img](http://cdn.jayh.club/uPic/640-20220601205340862ZDkfrG.png)

ä¿®æ”¹ Java è¿è¡Œç¯å¢ƒ

#### 5.2.3 æƒé™é—®é¢˜

ç»™ rc.local åŠ ä¸Šæƒé™, å¯ç”¨æœåŠ¡

```
sudo chmod +x /etc/rc.localsudo systemctl enable rc-localsudo systemctl stop rc-local.servicesudo systemctl start rc-local.servicesudo systemctl status rc-local.service
```

![img](http://cdn.jayh.club/uPic/640-20220601205340889qZvRw4.png)

Logstash å¯åŠ¨æˆåŠŸ

ç„¶åé‡å¯æœºå™¨ï¼ŒæŸ¥çœ‹ logstash è¿›ç¨‹æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œçœ‹åˆ°ä¸€å¤§ä¸² java è¿è¡Œçš„å‘½ä»¤åˆ™è¡¨ç¤º logstash æ­£åœ¨è¿è¡Œã€‚

```
ps -ef | grep logstash
```

## å…­ã€æ€»ç»“

æœ¬ç¯‡è®²è§£äº† Logstash åœ¨é›†ç¾¤ç¯å¢ƒä¸‹çš„éƒ¨ç½²æ¶æ„å›¾ã€Logstash é‡åˆ°çš„å‡ å¤§å‘ã€ä»¥åŠ Logstash çš„è¿è¡Œæœºåˆ¶å’Œæ¶æ„åŸç†ã€‚

Logstash è¿˜æ˜¯éå¸¸å¼ºå¤§çš„ï¼Œæœ‰å¾ˆå¤šåŠŸèƒ½æœªåœ¨æœ¬ç¯‡è¿›è¡Œè®²è§£ï¼Œæœ¬ç¯‡ä¹Ÿæ˜¯æŠ›ç –å¼•ç‰ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…æœ‹å‹ä»¬å¯ä»¥åŠ æˆ‘å¥½å‹ passjava å…±åŒæ¢ç´¢ã€‚

æ›´å¤šå¥½æ–‡è¯·æŸ¥çœ‹ï¼š

[å®æˆ˜ MySQL é«˜å¯ç”¨æ¶æ„](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451963004&idx=1&sn=2667d0e6e9142939e3645de680a4533f&chksm=8d1c05e3ba6b8cf5a6a0ab2ecb66af10496838e25814cbefcd45907dd652a5ec6ef3917b6ada&token=1170452569&lang=zh_CN&scene=21#wechat_redirect)

[ä¸€æ–‡å¸¦ä½ æ­å»ºä¸€å¥— ELK Stack æ—¥å¿—å¹³å°](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451962693&idx=1&sn=96530613aaadd8240d8a5c2ab7dff49d&chksm=8d1c02daba6b8bcc2499861fd37aac5cfa88d616fc839cb6a7a3c003118457ac325c3dcbeb62&scene=21#wechat_redirect)

å·¨äººçš„è‚©è†€

```
https://blog.csdn.net/xzk9381/article/details/109571087
https://www.elastic.co/guide/en/beats/filebeat/current/multiline-examples.html
https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/ecs-v1/grok-patterns
https://www.runoob.com/regexp/regexp-syntax.html
https://www.elastic.co/guide/en/beats/libbeat/current/config-file-permissions.html
https://www.tutorialspoint.com/logstash/logstash_supported_outputs.htm
```

### å‚è€ƒèµ„æ–™

[1]input æ’ä»¶åˆ—è¡¨: *https://www.elastic.co/guide/en/logstash/current/input-plugins.html*

[2]multiline å®˜æ–¹æ–‡æ¡£: *https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html#plugins-codecs-multiline-negate*

[3]Filebeat å®˜æ–¹æ–‡æ¡£: *https://www.elastic.co/guide/en/beats/filebeat/current/multiline-examples.html*

[4]Mutate å‚è€ƒæ–‡ç« : *https://blog.csdn.net/UbuntuTouch/article/details/106466873*

[5]Logstash æ¶æ„: *https://jenrey.blog.csdn.net/article/details/107122930*

\- END -

å†™äº†ä¸¤æœ¬ PDFï¼Œå›å¤ åˆ†å¸ƒå¼ æˆ– PDF ä¸‹è½½ã€‚

æˆ‘çš„ JVM ä¸“æ å·²ä¸Šæ¶ï¼Œå›å¤ JVM é¢†å–

![å›¾ç‰‡](http://cdn.jayh.club/uPic/640-20220601205340918yMN0nm.png)

***æˆ‘æ˜¯æ‚Ÿç©ºï¼ŒåŠªåŠ›å˜å¼ºï¼Œå˜èº«è¶…çº§èµ›äºšäººï¼***
