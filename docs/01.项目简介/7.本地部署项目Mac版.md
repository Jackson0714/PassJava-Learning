# Mac M1 玩转 Spring Cloud

我的开源 Spring Cloud 项目 `PassJava` 可以在 Windows 上正常运行，最近不是换 Mac M1了么，想把这个项目在 M1 上跑起来，毕竟我的那台 Windows 用起来发烫，是该体验下 M1 的性能了。

因为 M1 的兼容性不好，所以在从 0 开始跑这个项目的遇到了很多问题，比如 MySQL 工具经常打不开，前端 Vue 项目起不来，所以专门针对这些疑难杂症，我也做好了记录，相信对使用 M1 的同学有帮助。

我把后端、前端、小程序都上传到同一个仓库里面了，大家可以通过 github 或 码云访问。地址如下：

> **Github**: https://github.com/Jackson0714/PassJava-Platform
>
> **码云**：https://gitee.com/jayh2018/PassJava-Platform
>
> **配套教程**：www.passjava.cn

本文主要内容如下：

思维导图

## 一、配置 Nacos

### 1.1 下载地址

Nacos 下载地址：

``` http
https://github.com/alibaba/nacos/releases
```

最新版是 2.0.0-bugfix，我下载后，启动成功了，但是无法访问 Nacos 后台，怀疑是本地环境有问题，所以换了一个低版本的 1.4.1，可以正常工作。另外我之前在 windows 机器上使用的 1.2.1 的版本，拷贝到 Mac 上也能正常运行。



![image-20210415202053473](http://cdn.jayh.club/uPic/image-20210415202053473.png)

### 1.2 启动 Nacos

进入 nacos 根目录，执行命令：

``` sh
sh startup.sh -m standalone
```

执行后的结果如下图所示：

看到 nacos is starting withi standalone 就表示启动成功。注意：启动成功不代表正常运行。

![](http://cdn.jayh.club/uPic/image-20210415201228009.png)

接下来访问 nacos 的后台管理系统：

``` http
http://127.0.0.1:8848/nacos/#/login
```

![Nacos 登陆界面](http://cdn.jayh.club/uPic/image-20210415210654071.png)

账号和密码都是 `nacos`。

### 1.3 添加命名空间

添加 7 个微服务的命名空间：

![](http://cdn.jayh.club/uPic/image-20210415210949756.png)

新建命名空间时需要填写的字段：

![](http://cdn.jayh.club/uPic/image-20210415223534157.png)



### 1.4 添加 question 微服务配置

在配置列表添加几个微服务的配置，目前保证question 微服务有配置即可。

如下图所示，添加三个配置项：数据源，mybatis 配置，其他配置。详细的配置参数参照这篇来配置：`《SpringCloud整合Nacos配置中心》`。

![](http://cdn.jayh.club/uPic/image-20210415224144859.png)

## 二、初始化数据

创建数据库、表、初始化数据这些工作都需要做，下载一个 MySQL 客户端还是要方便点，然后找 Mac 上好用的客户端软件，下面是安装软件的艰辛历程。

### 1.1 安装 Mac 版 MySQL

首先需要安装 mac 版的 MySQL，下载地址：

``` http
https://dev.mysql.com/downloads/mysql/
```

选择第一个就可以了，官网已经提示该版本兼容 Mac M1

``` 
Packages for Catalina (10.15) are compatible with Big Sur (11)
```

![](http://cdn.jayh.club/uPic/image-20210416171926892.png)

下载后点击安装，安装成功后，到系统偏好配置里面找到 MySQL，并单击打开。

![](http://cdn.jayh.club/uPic/image-20210416172252026.png)

可以看到运行的 MySQL 实例是 MySQL 8.0.23，且默认开机运行。

![]![](http://cdn.jayh.club/uPic/image-20210416172644156.png)

### 2.2 安装 Mac 版图形化 MySQL 界面

#### 2.2.1 Workbench 在 M1 上不能运行

我试过安装 workbench 后，不能运行。

![](http://cdn.jayh.club/uPic/UTOOLS-CLIPBOARD-1618565321940.png)

#### 2.2.2  Squel Pro 在 M1 上不能运行

安装 Squel Pro 后，切换数据库的时候程序崩溃。

![image-20210416173839710](http://cdn.jayh.club/uPic/image-20210416173839710.png)

#### 2.2.3 Navicat

经过上面两个软件的崩溃后，我最后还是下载了试用版的 Navicat，可以免费用 14 天，对于初始化数据足够了。

下载地址：

``` sh
http://www.navicat.com.cn/download/navicat-for-mysql
```

下载 macOS 的最新版 15，它是兼容 M1 芯片的。

![](http://cdn.jayh.club/uPic/image-20210416183120950.png)

然后需要执行三个 SQL 文件，文件我已经上传到仓库上了，

```sh
/passjava-platform/data/sql
```

![](http://cdn.jayh.club/uPic/image-20210416195132717.png)

依次执行上面的三个文件后，会生成 6 个数据库，一个系统数据库，五个业务数据库。

![](http://cdn.jayh.club/uPic/image-20210416201245011.png)

## 三、启动微服务

### 3.1 下载安装 IDEA

我安装的 IDEA 是 2020.3 的，试用版 30 天。将项目打开后，需要 build 下。![image-20210417000630492](http://cdn.jayh.club/uPic/image-20210417000630492.png)

### 3.2 启动 renren-fast 服务

我们的后台框架是用的人人框架，所以需要启动renren 后台

![](http://cdn.jayh.club/uPic/image-20210417003249707.png)

网关 passjava-gateway，题目服务 passjava-question。



## 三、启动 Admin 后台

Admin 管理后台的技术选型还是用的 Vue，所以需要使用 npm 工具来安装依赖。

### 3.1 安装 npm、nvm

使用 homebrew 安装 npm

```sh
brew install npm
```

![](http://cdn.jayh.club/uPic/image-20210416204951214.png)

使用 homebrew 安装 nvm

```
brew install nvm
```

![](http://cdn.jayh.club/uPic/image-20210416211547660.png)

### 3.2 切换镜像源

默认的 npm 使用的是官方的镜像源，我们切换为国内的淘宝镜像源。

``` sh
npm install -g cnpm --registry=https://registry.npm.taobao.org --verbose
```

![](http://cdn.jayh.club/uPic/image-20210416205116707.png)

 ### 3.3 安装 node_module

仓库里面并没有将依赖包一起上传，因为依赖包太大了，所以可在本地通过如下命令安装依赖包，这个是一次性的，后面不需要再执行。

进入到 passjava-platform/passjava-portal 目录，执行如下命令来安装依赖：

```sh
cnpm install
```

![](http://cdn.jayh.club/uPic/image-20210416211729789.png)

启动前端portal

```sh
npm run dev
```

报错，提示 Node Sass 不兼容当前的系统：

``` sh
Node Sass does not yet support your current environment: OS X Unsupported architecture (arm64) with Unsupported runtime (88)
```

![](http://cdn.jayh.club/uPic/image-20210416212055167.png)

根据网上提供的解决方案，要先卸载 Node Saas

``` sh
cnpm uninstall node-sass
```

但是又提示 chromedriver 安装失败（当前操作系统不兼容），根据网上的解决方案，单独安装，但依旧提示 64 位系统不兼容，于是我把 package.json 文件中的 "chromedriver": "2.27.2" 删掉了，问题迎刃而解！最新的代码已删除该依赖项配置。

先删除之前安装 node_modules

```sh
rm -rf ./node_modules/
```

再次执行卸载 node-sass 的命令：

``` sh
cnpm uninstall node-sass
```

卸载成功后，安装 node-sass

``` sh
cnpm install node-sass  --unsafe-perm --save-dev
```

![image-20210416224957858](http://cdn.jayh.club/uPic/image-20210416224957858.png)

重新安装依赖

``` sh
cnpm install
```

![](http://cdn.jayh.club/uPic/image-20210416225210584.png)

启动后台

```sh
npm run dev
```

启动成功后，会自动打开浏览器，访问的地址是 http://localhost:8081

![](http://cdn.jayh.club/uPic/image-20210416225322860.png)





登陆后台

1.启动RenrenAplication

2.输入用户名和密码登陆

![PassJava后台](http://cdn.jayh.club/uPic/DQDm4seRS85s.png)









