

# Keepalived 高可用的三种路由方案

原文首发：[公众号：悟空聊架构]



你好，我是悟空。

[Keepalived 高可用上篇](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451963624&idx=1&sn=298b4917b0782f4c621589ad78f10ac2&chksm=8d1c0777ba6b8e61a8ed45286057c1a2a530f466bd3dfd293a1eb5d1913f819a5713af7c88cb&token=1036865606&lang=zh_CN#rd)已经发布，

有位读者朋友提出一个疑问：

> 主向备发送的到底是 VRRP 还是 ARP 广播报文？

纠正上篇的内容：

- 主向备发送的 VRRP 协议的广播报文，里面携带了优先级 priority 字段。

- 主向局域网内广播 ARP 请求分组，告诉局域网自己的 IP 地址和 MAC 地址。客户端就知道了主的 IP 地址和 MAC 地址。
- 假如发生了主备切换，虽然 IP 没变，还是 VIP，但是 MAC 地址已经变了，客户端发送 IP 数据报时，从自己的  ARP 高速缓存中找到 VIP 对应的 MAC 地址，把 MAC 地址写入 MAC 帧，然后通过局域网把该 MAC 帧发往此硬件地址。   

本篇涉及以下内容：

- Keepalived 的路由方案。
- Keepalived 如何监控服务的。
- Keepalived 如何进行故障切换。
- Keepalived 的架构剖析。

## 一、Keepalived 的路由方案

上篇我们讲到 Keepalived 的负载均衡调度算法，通过这个算法选出某台真实服务来处理本次客户端请求。

但是后续有两个流程需要梳理下：

- Keepalived 如何将请求转发给这个服务呢？
- 服务处理完这个请求后，如何将处理结果返回给客户端？

这个就是 Keepalived 的路由方案要做的事。

Keepalived 的基于三种路由方案：NAT、TUN、DR。

### 1.1 NAT 路由方案

NAT 的全称是 Network Address Translation，网络地址转换。

- 使企业内部的私有 IP 可以访问外网，

- 使外部用户可以访问位于公司内部的私有 IP 主机。

 如下图所示，LVS 负载调度器有两块网卡，配置了不同的 IP 地址，网卡 eth0 设置为私有 VIP 与内部网络通过交换设备相互连接，网卡 eth1 设置为公网 VIP 与外部网络连通。

示例如下：

eth0 网卡 -> 公网 VIP -> 外部网络

eth1 网卡 -> 私有 VIP -> 交换设备 > 内网网络

原理图如下所示：

![](http://cdn.jayh.club/uPic/image-20220703154558103IAYFpB.png)

① 比如现在 eth0 网卡配置了一个公有 VIP 如 10.1.2.88，客户端发送的请求都是到这个 Public VIP（目标地址）。

② 主 LVS Router 负责接收请求，将请求的目的地址（Public VIP）替换成 NAT VIP（192.168.56.88）。

③ 这个 NAT VIP 和后端服务同属一个局域网，可以相互访问，请求经过负载均衡调度选择一个真实服务器。

④ LVS 修改数据包中的目标地址和目标端口为真实服务器的。

⑤ 真实服务器处理完请求后，将应答数据返回给 LVS Router。

⑥ LVS Router 将应答数据的源 IP 地址 NAT VIP 和端口转换成 Public VIP 和 LVS 的端口，然后转发给外部网络的客户端。

对于客户端而言，它只和 Public VIP 打交道，并不知道 NAT VIP，更不知道真实服务器的 IP 地址，这个过程也称为 IP 伪装。

### 1.2 TUN 路由方案

NAT 路由方案的存在瓶颈，由于所有的数据请求及响应的数据包都需要经过 LVS 调度器转发，如果后端服务数量很多，客户端访问流量也很大的话，那么调度器会忙于调度转发和地址替换等操作。

为了解决 NAT 的性能问题，TUN 路由方案是个比较好的选择。

TUN 其实是 tunning（隧道）的缩写，而 TUN 路由方案就是基于



客户端想要发送查询数据库的请求给 MySQL 服务，通过域名或 IP + 端口就可以访问到了。

首先需要通过域名解析服务（DNS）解析出 MySQL 服务对应的 IP 地址，























## 二、Keepalived 是如何监控服务的

监测 TCP，notify script

用脚本监测



## 三、Keepalived 如何实现故障转移的

主备切换，接管 VIP 流量，转发流量到服务

根据优先级切换，但是会产生不必要的主备切换。

如果不根据优先级切换，不抢占，若要切换，则只能让 keepalived 宕机，另外一台 keepalived 成为 master

## 四、Keepalived 的架构原理





《Linux 运维之道》

《OpenStack 高可用集群》



