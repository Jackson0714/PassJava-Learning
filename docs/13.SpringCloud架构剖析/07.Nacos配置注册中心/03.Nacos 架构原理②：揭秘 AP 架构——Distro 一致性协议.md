# Nacos 架构原理②：揭秘 AP 架构——Distro 一致性协议



大家好，我是悟空呀。

## 前言

上篇我们讲解了 Nacos 的架构原理：一条注册请求会经历什么。

[Nacos 架构原理①：一条注册请求会经历什么？](http://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451962520&idx=1&sn=864d6aa4a796be28b77379c66e317b44&chksm=8d1c0307ba6b8a11a62cd5b915857dc8013ad83b35c90c3050fc2e77cf836ea24517717e1e92#rd)

这次我们来聊下 Nacos 非常重要的一个协议 Distro。

我们知道 Nacos 它是支持 CP（分区一致性）和 AP（分区可用性） 的，而 AP 是通过 Nacos 自研的 Distro 协议来保证的。本篇会带着大家从源码角度来深入剖析下 Distro 协议。

## Distro 的设计思想

`Distro` 协议是 Nacos 对于`临时实例数据`开发的一致性协议。

临时数据存储在`内存缓存`中，并且其他节点在启动时会进行全量数据同步，然后节点定期进行数据校验。

大家不要被这个协议吓到，其实就是阿里自己实现的一套同步逻辑。

AP 中的 P 代表网络分区，所以 Distro 在分布式集群环境下才能真正发挥其作用。它保证了在多个 Nacos 节点组成的 Nacos 集群环境中，当其中某个 Nacos 宕机后，整个集群还是能正常工作。

Distro 的设计原则：

- Nacos 的每个节点是平等的，都可以处理写请求，然后把变更的数据同步到其他节点。
- 每个节点只存了部分数据，定时发送自己负责的数据的校验值到其他节点来保持数据一致性。
- 每个节点独立处理读请求，及时从本地发出响应。



## 问题3：Nacos 集群间如何同步数据？

```java
consistencyService.put(key, instances);	
```

把服务实例放到内存里面，发起一个延迟异步的数据复制任务，把数据复制到其他 Nacos 节点。

### 数据存储

dataStore.put(key, datum);

### 任务

延迟 1s，遍历每个 Nacos 节点，发起异步同步。

## 客户端如何从 Nacos 集群读取数据？



## Nacos 的注册表的数据结构是怎么样的？

