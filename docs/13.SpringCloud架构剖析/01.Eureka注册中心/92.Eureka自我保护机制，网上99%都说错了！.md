# Eureka 的自我保护机制，网上 99% 都说错了！

85% 

服务实例明明宕机了，为什么下线不了？



你好，我是悟空。

## 一、何为自我保护机制？

在研究 Eureka 原理的时候，发现自我保护机制是 Eureka 非常核心的一个功能。

要理解自我保护机制就需要知道 Eureka 的心跳机制，所谓心跳机制，就是客户端每隔 30 秒向 Eureka 发送一个心跳请求，告诉自己还存活着。如果客户端长时间内没有发送心跳请求，则 Eureka 认为这个客户端宕机了，则从 Eureka 注册表中移除这个客户端（下线这个客户端）。

> 原理图

自我保护机制就是，当发现有很多服务在短时间内和 Eureka 的通信中断，则 Eureka 会认为可能是自己误判造成的，比如因为 Eureka 服务本身的网络出现故障，导致很多客户端发送的心跳请求，Eureka 自己收不到，但并不能说明客户端宕机了。这个时候，Eureka 就会触发自我保护机制，不移除客户端了。

> 原理图

## 二、网上都怎么说？

网上搜了下 Eureka 的自我保护机制，搜到的答案几乎都是这样的：

![](http://cdn.jayh.club/uPic/image-20220619094136053Q8Duev.png)

这明显不对啊，来看看里面的两个关键信息：15 分钟内，超过 85 % 的客户端。

### 2.1 在 15 分钟内

- 15 分钟内，这个时间也忒长了吧。我们来看下为什么不合理：

假设 Eureka 没有收到客户端的心跳，那么 Eureka 就认为这个客户端宕机了，就直接摘除了这个客户端，然后过了 15 分钟后，有很多客户端其实被摘除了，那再开启自我保护机制已经晚了，因为很多客户端在 15 分钟这么长的内的时间极有可能都被摘除了！

### 2.2 超过 85 % 的客户端

- 超过 85 % 的客户端，这个百分比也忒高了吧。我们来看下为什么不合理：

如果真的等到超过 85 % 的客户端都没有正常发送心跳，那最后都被 Eureka 摘除了，再开启自我保护机制没有意义了啊，只剩下 15 % 的客户端是不足以提供服务的！

那自我保护机制到底是怎么样的？我们通过源码一探究竟。

## 三、通过源码一探究竟



​											
