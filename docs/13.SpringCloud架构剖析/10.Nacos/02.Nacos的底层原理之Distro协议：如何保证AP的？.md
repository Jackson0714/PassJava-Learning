大家好，我是悟空呀。

## 前言

上篇我们讲解了如何使用 Nacos 作为注册中心和配置中心。

[6000 字｜20 图｜Nacos 手摸手教程](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451962038&idx=1&sn=fd97b0d0a3b1138aeff36080bd19f31b&chksm=8d1c0129ba6b883fb3f2aa68ffd9107dfc39df9798271d8f40382a1be52bd10a06b566071fc4&token=388174649&lang=zh_CN#rd)

这次我们来聊下 Nacos 非常重要的一个协议 Distro。

我们知道 Nacos 它是支持 CP（分区一致性）和 AP（分区可用性） 的，而 AP 是通过 Nacos 自研的 Distro 协议来保证的。本篇会带着大家从源码角度来深入剖析下 Distro 协议。

## Distro 的设计思想

Distro 协议是 Nacos 对于`临时实例数据`开发的一致性协议。其数据存储在`缓存`中，并且会在启动 时进行全量数据同步，并定期进行数据校验。

AP 中的 P 代表网络分区，所以 Distro 在分  布式集群环境下才会发挥作用，也就是说它保证了在多个 Nacos 节点组成的 Nacos 集群环境中，当其中某个 Nacos 宕机后，整个集群还是能正常工作。

Distro 的设计原则：

- Nacos 的每个节点是平等的，都可以处理写请求，然后把变更的数据同步到其他节点。
- 每个节点只存了部分数据，定时发送自己负责的数据的校验值到其他节点来保持数据一致性。
- 每个节点独立处理读请求，及时从本地发出响应。

## Nacos 集群环境长什么样？

首先我在本地搭建了一个 Nacos 集群环境，有 3 个 Nacos 服务，它们的 IP 相同，端口号不同。

``` sh
192.168.10.197:8848
192.168.10.197:8858
192.168.10.197:8868
```

![](http://cdn.jayh.club/uPic/image-20220408100844549MpxWbb.png)

然后服务 A 和服务 B 都是配置了 Nacos 集群的 IP 和 端口号的，配置如下所示

```java
spring.cloud.nacos.discovery.server-addr
  =192.168.10.197:8848,192.168.10.197:8858,192.168.10.197:8868
```

整体的结构如下图所示，服务 A 和 服务 B 都往 Nacos 集群进行注册。

![](http://cdn.jayh.club/uPic/image-20220408101723181kPWAUa.png)

## Nacos 如何处理客户端写请求？

当客户端，也就是上图中的服务 A 和 服务 B，发起`注册`的写请求时，请求中包含了 IP + port，这个信息就是 Nacos 集群中某个 Nacos 的 IP + port。客户端其实是随机选择了一个 配置信息中的 IP + port 发起注册。

如下图所示：

![](http://cdn.jayh.club/uPic/image-20220408155706056iCyGw5.png)

服务 A 给 Nacos 2 发起注册，携带的 IP + port 和 Nacos 2 的不匹配，Nacos 2 会进行路由转发，转发给 Nacos 1。

如果 Nacos 节点接收到属于该节点负责的示例的写请求时，直接写入。

那么这其中就会有几个问题：

> 问题 1：客户端如何选择那一个 Nacos 发起注册请求？
>
> 问题 2：注册失败怎么处理？
>
> 问题 3：Nacos 是对写请求如何进行路由转发的？
>
> 问题 4：Nacos 如何接收注册请求的？
>
> 问题 3：Nacos 集群间是如何同步数据的？
>
> 问题 4：Nacos 注册表的数据结构是怎么样的？

带着这几个问题，我们分别来分析。

## 问题 1：客户端如何选择 Nacos 发起注册请求？

答案：随机拿到 Nacos 集群服务列表中的一个地址。

流程图如下：

![](http://cdn.jayh.club/uPic/image-20220410102943326odrkkO.png)

注册的源码路径：

```SH
client/src/main/java/com/alibaba/nacos/client/naming/remote/gprc/NamingGrpcClientProxy.java
```

顺着下面这个方法，有一个发起注册的方法：

![](http://cdn.jayh.club/uPic/image-202204081659016589e981D.png)

Client 会发起远程调用，就是这一行代码：

```java
rpcClient.request(request, requestTimeout);
```

![](http://cdn.jayh.club/uPic/image-20220408170451470T4fKkZ.png)

接着 request 方法往下看，里面用  currentConnection 发起请求：

```java
response = this.currentConnection.request(request, timeoutMills);
```

这个 currentConnection 是客户端和 Nacos 集群中的某个节点建立的连接，我们找下它在哪里赋值的。代码如下：

```java
serverInfo = recommendServer.get() == null ? nextRpcServer() : recommendServer.get();
connectToServer = connectToServer(serverInfo);
this.currentConnection = connectToServer;
```

而连接的信息是通过参数 serverInfo 传进去的，所以我们再看下 serverInfo 在哪里赋值的。

这个 nextRpcServer() 方法里面会拿到一个随机的 Nacos 地址：

```java
// 一个 int 随机数，范围 [0 ~ Nacos 个数)
currentIndex.set(new Random().nextInt(serverList.size()));
// index 自增 1
int index = currentIndex.incrementAndGet() % getServerList().size();
// 返回 Nacos 地址
return getServerList().get(index);
```

**小结**：客户端生成一个随机数，然后通过这个随机数从 Nacos 服务列表中拿到一个 Nacos 服务地址返回给客户端，然后客户端通过这个地址和 Nacos 服务建立连接。

## 问题 2：Nacos 对写请求是如何进行路由转发的？

我们先要找到 Nacos 处理写请求的入口。我是这样来找的，先看下发起注册的时候，request 长啥样，代码如下：

```java
InstanceRequest request = new InstanceRequest(namespaceId, serviceName, groupName,
        NamingRemoteConstants.REGISTER_INSTANCE, instance);
```

会创建一个 request，里面指定了 Nacos 的地址信息、API 的类型（注册实例）、客户端实例信息。我们发现这里只能通过这个API 类型来搜索是否有 Nacos 服务也使用了。果不其然，找到了一个：

![](http://cdn.jayh.club/uPic/image-20220410110704520KkW9Zo.png)



## 问题3：Nacos 集群间如何同步数据？

```java
consistencyService.put(key, instances);	
```

把服务实例放到内存里面，发起一个延迟异步的数据复制任务，把数据复制到其他 Nacos 节点。

### 数据存储

dataStore.put(key, datum);

### 任务

延迟 1s，遍历每个 Nacos 节点，发起异步同步。

## 客户端如何从 Nacos 集群读取数据？



## Nacos 的注册表的数据结构是怎么样的？

