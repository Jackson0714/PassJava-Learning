# Eureka 服务注册与发现的原理和简单使用

## 一、基本原理

现在有一个订单服务部署在一台机器上，另外有两个商品服务部署在两台机器上。

所有服务都注册到 eureka 上，当订单服务想要调用商品服务时，其实是从 eureka 上获取商品服务的地址。

![](http://cdn.jayh.club/blog/20211004/DjwfE5UOXRLG.png?imageslim)

当有一个商品服务宕机后，eureka 会把这个服务的注册信息移除掉，订单服务也不会调用这个商品服务。

![](http://cdn.jayh.club/blog/20211004/cWLSnC2YevIH.png?imageslim)

下面我们简单使用下 Eureka。

> 场景：首先有一个服务 A，一个服务 B，服务 B 不知道服务 A 的 IP 地址，只知道服务 A 的名字，服务 B 通过向 eureka 获取到了服务 A 的具体 IP 地址，然后成功调用服务 A 的 passjava API。

## 二、创建 Eureka Server

创建一个 Eureka 服务。

Spring Cloud 基于 Hoxton.SR10 版本，Spring Boot 基于 2.3.2.RELEASE。

### pom.xml 文件

```
  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.3.2.RELEASE</version>
  </parent>
  
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-dependencies</artifactId>
        <version>Hoxton.SR10</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
    </dependencies>
  </dependencyManagement>
  
  <dependencies>
    <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-config</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-eureka</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>

  </dependencies>
```

### 启动类

```java
/**
 * @Author: 公众号 | 悟空聊架构
 * @Date: 2021/9/13 7:28
 * @Site: www.passjava.cn
 * @Github: https://github.com/Jackson0714/eureka-learning
 */
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

### 配置项, application.yml 文件

```yaml
server:
  port: 8761
eureka:
  client:
    register-with-eureka: false
    fetch-registry: false
```

register-with-eureka: 不要把自己注册到 Eureka，因为它自己就是 Eureka 服务，让别人来注册的

fetch-registry: 不要到 Euraka 服务抓取注册信息

### 启动

浏览器访问 http://localhost:8761/

![](http://cdn.jayh.club/blog/20211004/jgLJTJYsh0a0.png?imageslim)

## 三、创建服务 A

### pom.xml 文件

```
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
      <version>Hoxton.SR10</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
 </dependencies>
</dependencyManagement>

<dependencies>
  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
  </dependency>
  <dependency>
    <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-config</artifactId>
  </dependency>
  <dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
  </dependency>
</dependencies>
```

### application.yml 配置

```yaml
server:
  port: 8091
spring:
  application:
    name: ServiceA
eureka:
  instance:
    hostname: localhost
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka
```

### Controller 类

```java
@RestController
public class ServiceAController {

	@RequestMapping(value = "/passjava/{name}",
			method = RequestMethod.GET)
	public String sayHello(@PathVariable("name") String name) {

		return "hello" + name;
	}
}
```

### 启动类

```java
/**
 * @Author: 公众号 | 悟空聊架构
 * @Date: 2021/9/13 7:28
 * @Site: www.passjava.cn
 * @Github: https://github.com/Jackson0714/eureka-learning
 */
@SpringBootApplication
@EnableEurekaClient
public class ServiceAApplication {

   public static void main(String[] args) {
      SpringApplication.run(ServiceAApplication.class, args);
   }

}
```

### 测试服务 A 是否已启动

Eureka 控制台可以看到服务 A 已启动

![mark](http://cdn.jayh.club/blog/20211004/lIAgy7xryGJo.png?imageslim)

测试服务 A 是否能访问

```sh
http://localhost:8005/passjava/悟空
```

返回结果：

![](http://cdn.jayh.club/blog/20211004/Def2YPTLQyvA.png?imageslim)

## 四、创建服务 B

### 服务 B 和 服务 A 的区别

- 多了一个 netflix。

- 服务 B 会调用服务 A。

``` YAML
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-netflix-ribbon</artifactId>
</dependency>
```

### 服务 B 调用服务 A 的 passjava api

```java
public class ServiceBController {

   @Bean
   @LoadBalanced
   public RestTemplate getRestTemplate() {
      return new RestTemplate();
   }

   @RequestMapping(value = "/test/{name}", method = RequestMethod.GET)
   public String test(@PathVariable("name") String name) {
      RestTemplate restTemplate = getRestTemplate();
      return restTemplate.getForObject("http://ServiceA/passjava/" + name, String.class);
   }
   
}
```

我们看到有一个  @LoadBalanced 注解，这里做下说明：

RestTemplate  用来实现单个 http 请求的，加了 @LoadBalanced 注解后，就可以实现负载均衡，访问

### 测试

启动服务 B，可以在 eureka 控制台看到服务 B 在注册列表上。

![](http://cdn.jayh.club/blog/20211004/ibEDfRSS193f.png?imageslim)

测试访问 test api

```SH
http://localhost:9001/test/悟空2
```

测试结果：

![](http://cdn.jayh.club/blog/20211004/uHaR0OwdhnVc.png?imageslim)

说明服务 B 拿到了 服务 A 的 url 信息，然后成功调用服务 A。

