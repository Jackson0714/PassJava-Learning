# 让你设计一个负载均衡组件，你会怎么设计？



大家好，我是悟空。

今天我们来看下微服务中非常重要的一个组件：Ribbon。它作为负载均衡器在分布式网络中扮演着非常重要的角色。

在介绍 Ribbon 之前，不得不说下负载均衡这个比较偏僻的名词。为什么说它偏僻了，因为在面试中，聊得最多的是消息队列和缓存来提高系统的性能，支持高并发，很少有人会问负载均衡，究其原因，负载均衡的组件选择和搭建一般都是运维团队或者架构师去做的，开发人员确实很少接触到。不过没关系，我们不止有 CRUD，还要有架构思维。

# 一、负载均衡

## 1.1 概念

上次我在这篇文章中详细讲解了何为高可用，里面没有涉及到负载均衡机制，其实负载均衡也是高可用网络的关键组件。

简单来说，负载均衡就是将网络流量分摊到不同的网络服务器，系统就实现了业务的水平横向扩展。

> 插入流量分摊的图片

两个基本点：

- 选择哪个服务器来处理客户端请求。
- 将客户端请求转发出去。

一个核心原理：通过硬件或软件的方式维护一个服务列表清单。当用户发送请求时，会将请求发送给负载均衡器，然后根据负载均衡算法从可用的服务列表中选出一台服务器的地址，将请求进行转发，完成负载功能。

## 1.2 负载均衡的特性

高性能：可根据不同的分配规则自动将流量进行分摊。

可扩展性：可以很方便增加集群中设备或链路的数量。

高可靠性：系统中某个设备或链路发生故障，不会导致服务中断。

易配置性：配置和维护方便。

透明性：用户感知不到如何进行负载均衡的，也不用关心负载均衡。

## 1.3 负载均衡分类

负载均衡技术可以按照软件或硬件进行分类，也可以按照服务器列表存放的位置划分为服务端负载和客户端负载均衡。

### 1.3.1 硬件负载均衡

F5 就是常见的硬件负载均衡产品。

优点：性能稳定，具备很多软件负载均衡不具备的功能，如应用交换，会话交换、状态监控等。

缺点：设备价格昂贵、配置冗余，没有软件负载均衡灵活，不能满足定制化需求。

### 1.3.2 软件负载均衡

DNS：

Nginx：

LVS（Linux Virtual Server）：是一个虚拟服务器集群系统，采用 IP 地址均衡技术和内容请求分发技术实现负载均衡。

### 1.3.3 服务端负载均衡

Nginx 和 F5 都可以划分到服务端的负载均衡里面，后端的服务器地址列表是存储在后端服务器中或者存在专门的 Nginx 服务器或 F5 上。

服务器的地址列表的来源是通过注册中心或者手动配置的方式来的。

如何更新服务器列表？通过心跳检测机制剔除不可达的服务器。

>插入图片

### 1.3.4 客户端负载均衡

终于轮到 Ribbon 登场了，它属于客户端负载均衡器，客户端自己维护一份服务器的地址列表。这个维护的工作就是由 Ribbon 来干的。

Ribbon 会从 Eureka Server 读取服务信息列表，存储在 Ribbon 中。如果服务器宕机了，Ribbon 会从列表剔除宕机的服务器信息。

Ribbon 有多种负载均衡算法，我们可以自行设定，请求到指定的服务器。

> 插入图片

## 1.3 均衡策略

上面已经介绍了各种负载均衡分类，接下来我们来看下这些负载均衡器如何通过负载均衡策略来选择服务器处理客户端请求。

- 轮训均衡（Round Robin）：





# 二、Ribbon 简单使用



# 三、 Ribbon 架构



# 四、Ribbon 常用配置项

