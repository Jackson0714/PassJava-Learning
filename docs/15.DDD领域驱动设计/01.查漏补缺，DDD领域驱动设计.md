

# 「查缺补漏」，DDD 核心概念梳理

## 一、概述

DDD 是什么，DDD 的英文全称是 Domain-Driven Design，翻译过来就是领域驱动设计。

这种设计一般是用在微服务的系统中，当我们聊微服务的时候，争论最多的就是如何进行微服务的拆分，这也是最让人产生争议的地方。

当我们聊微服务也必然会会聊到中台，中台又是什么呢？

### 中台

中台从 2015 年提出，就已经被我们熟知，但是每个人对中台的认识可能都千差万别，有没有一个大家都比较认可的定义呢?

> 将通用的`可复用`的业务能力沉淀到中台业务模型，实现企业级能力复用。

因此中台面临的首要问题就是中台领域模型的重构。

而中台落地时，依然会面临微服务设计和拆分的问题。

- 微服务：中台落地时需要用微服务进行支撑。

- 中台：复用业务，实现企业级能力复用。

- DDD：对中台进行领域建模，实现适合企业发展的中台。

## 二、DDD 是什么？

DDD 的核心思想：是通过领域驱动设计方法定义领域模型，从而确定业务和应用边界，保证业务模型与代码模型的一致性。

DDD 是一种处理高度复杂领域的设计思想，它试图分离技术实现的复杂性，并围绕业务概念构建领域模型来控制业务的复杂性，以解决软件难以理解，难以演进的问题。

战略设计：主要从业务视角出发，建立业务领域模型，划分领域边界，建立通用语言的限界上下文，限界上下文可以作为微服务设计的参考边界。

战术设计：则从技术视角出发，侧重于领域模型的技术实现，完成软件开发和落地，包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现。

## 三、架构分层

![](http://cdn.jayh.club/uPic/image-20220207112744158omko66.png)

### 用户接口层

用户接口层主要包含用户界面、Web 服务

用户接口层负责向用户显示信息和解释用户指令。这里的用户可能是：用户、程序、自动化测试和批处理脚本等等。

### 应用层

应用层不应该有业务逻辑。



应用层是很薄的一层，理论上不应该有业务规则或逻辑，主要面向用例和流程相关的操作。

应用服务是在应用层的，它负责服务的组合、编排和转发，负责处理业务用例的执行顺序以及结果的拼装，以粗粒度的服务通过 API 网关向前端发布。还有，应用服务还可以进行安全认证、权限校验、事务控制、发送或订阅领域事件等。



- 应用层：应用服务。
- 领域层：聚合：实体、值对象、领域服务。
- 基础层：数据库、事件总线、API 网关、缓存，基础服务、第三方工具、其它基础组件。

## 三、领域分类

领域，子域，核心域，通用域，支撑域。



## 四、

用来封装通用语言和领域对象，提供上下文环境，保证在领域之内的一些术语、业务相关对象等（通用语言）有一个确切的含义，没有二义性。

理论上限界上下文就是微服务的边界。我们将限界上下文内的领域模型映射到微服务，就完成了从问题域到软件的解决方案。

## 通用语言

DDD 分析和设计过程中的每一个环节都需要保证限界上下文内术语的统一，在代码模型设计的时侯就要建立领域对象和代码对象的一一映射，从而保证业务模型和代码模型的一致，实现业务语言与代码语言的统一。

如果不考虑技术异构、团队沟通等其它外部因素，一个限界上下文理论上就可以设计为一个微服务。

## 实体

实体和值对象是组成领域模型的基础单元。

类包含了实体的属性和方法，通过这些方法实现实体自身的业务逻辑。

实体类通常采用充血模型。

实体以 DO（领域对象）的形式存在，每个实体对象都有唯一的 ID。字段的值可以变。

实体是看得到、摸得着的实实在在的业务对象，实体具有业务属性、业务行为和业务逻辑。

**特点**：有 ID 标识，通过 ID 判断相等性，ID 在聚合内唯一。依附于聚合根，生命周期由聚合根管理。实体一般会持久化，但是与数据库持久化对象不一定是一对一的关系。实体可以引用聚合内的聚合根、实体和值对象。

## 值对象

通过对象属性值来识别的对象，它将多个相关属性组合为一个概念整体。在 DDD 中用来描述领域的特定方面，并且是一个没有标识符的对象，叫作值对象。

值对象描述了领域中的一件东西，这个东西是不可变的，它将不同的相关属性组合成了一个概念整体。

值对象是 DDD 领域模型中的一个基础对象，它跟实体一样都来源于事件风暴所构建的领域模型，都包含了若干个属性，它与实体一起构成聚合。

值对象只是若干个属性的集合，只有数据初始化操作和有限的不涉及修改数据的行为，基本不包含业务逻辑。值对象的属性集虽然在物理上独立出来了，但在逻辑上它仍然是实体属性的一部分，用于描述实体的特征。

值对象采用序列化大对象的方法简化了数据库设计，减少了实体表的数量，可以简单、清晰地表达业务概念。这种设计方式虽然降低了数据库设计的复杂度，但却无法满足基于值对象的快速查询，会导致搜索值对象属性值变得异常困难。

**实体和值对象区别**：

实体和值对象的目的都是抽象聚合若干属性以简化设计和沟通，有了这一层抽象，我们在使用人员实体时，不会产生歧义，在引用地址值对象时，不用列举其全部属性，在同一个限界上下文中，大幅降低误解、缩小偏差，两者的区别如下：
①两者都经过属性聚类形成，实体有唯一性，值对象没有。在本文案例的限界上下文中，人员有唯一性，一旦某个人员被系统纳入管理，它就被赋予了在事件、流程和操作中被唯一识别的能力，而值对象没有也不必具备唯一性。
②实体着重唯一性和延续性，不在意属性的变化，属性全变了，它还是原来那个它；值对象着重描述性，对属性的变化很敏感，属性变了，它就不是那个它了。
③战略上的思考框架稳定不变，战术上的模型设计却灵活多变，实体和值对象也有可能随着系统业务关注点的不同而更换位置。比如，如果换一个特殊的限界上下文，这个上下文更关注地址，而不那么关注与这个地址产生联系的人员，那么就应该把地址设计成实体，而把人员设计成值对象。

**值对象的特点**：无 ID，不可变，无生命周期，用完就不需要了。值对象之间通过属性值判断相等性。核心本质是值，是一组概念完整的属性组成的集合，用于描述实体的状态和特征，值对象尽量只引用值对象。

## 聚合

聚合就是由业务和逻辑紧密关联的实体和值对象组合而成。

聚合是数据修改和持久化的基本单元，每一个聚合对应一个仓储，实现数据的持久化。

聚合有一个聚合根和上下文便捷，根据业务单一职责和高内聚原则，定义了聚合内部应该包含哪些实体和值对象，而聚合之间的边界是松耦合的。

`聚合`属于 DDD `领域层`，领域层包含多个聚合，共同实现核心业务逻辑。

聚合内的`实体`以`充血模型`实现个体业务能力，以及业务逻辑的高内聚。

跨多个实体的业务逻辑通过领域服务来实现，跨多个聚合的业务逻辑通过应用服务来实现。

**特点**：高内聚、低耦合，它是领域模型中最底层的边界，可以作为拆分微服务的最小单位，但是不建议对微服务过度拆分。一个聚合可以作为一个微服务，以满足版本的高频发布和极致的弹性伸缩能力。一个微服务也可以包含多个聚合，可以进行拆分和组合。

## 聚合根

聚合根是为了避免由于复杂数据模型缺少统一的业务规则控制，从而导致聚合、实体之间数据不一致性的问题。

聚合可以比作组织，聚合根就是这个组织的负责人。

外部对象不能直接访问聚合内实体，需要先访问聚合根，再导航到聚合内部实体。

**特点**：聚合根是实体，有实体的特点，具有全局唯一标识，有独立的生命周期。一个聚合只有一个聚合根，聚合根在聚合内对实体和值对象采用直接对象引用的方式进行组织和协调，聚合根和聚合根之间通过 ID 关联的方式实现聚合之间的协同。

## 领域事件

领域事件用来表示领域中发生的事件。一个领域事件将导致进一步的业务操作，在实现业务解耦的同时，有助于形成完成的业务闭环。

领域事件驱动设计可以切断领域模型之间的强依赖关系，事件发布完成后，发布方不必关心后续订阅方事件处理是否成功，可以实现领域模型的解耦，维护领域模型的独立性和数据的一致性。微服务之间的数据不必要求强一致性，而是基于事件的最终一致性。

领域事件的执行需要一系列的组件和技术来支撑：事件的构建和发布、事件数据持久化、事件总线、消息中间件、事件接收和处理。

## 架构分层



## 头脑风暴





## DDD 架构分类

