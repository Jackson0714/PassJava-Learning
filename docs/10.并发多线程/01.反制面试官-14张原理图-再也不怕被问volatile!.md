> æ‚Ÿç©º
> çˆ±å­¦ä¹ çš„ç¨‹åºçŒ¿ï¼Œè‡ªä¸»å¼€å‘äº†Javaå­¦ä¹ å¹³å°ã€PMPåˆ·é¢˜å°ç¨‹åºã€‚ç›®å‰ä¸»ä¿®Javaã€å¤šçº¿ç¨‹ã€SpringBootã€SpringCloudã€k8sã€‚æœ¬å…¬ä¼—å·ä¸é™äºåˆ†äº«æŠ€æœ¯ï¼Œä¹Ÿä¼šåˆ†äº«å·¥å…·çš„ä½¿ç”¨ã€äººç”Ÿæ„Ÿæ‚Ÿã€è¯»ä¹¦æ€»ç»“ã€‚


# çµ®å¨

è¿™ä¸€ç¯‡ä¹Ÿç®—æ˜¯Javaå¹¶å‘ç¼–ç¨‹çš„å¼€ç¯‡ï¼Œçœ‹äº†å¾ˆå¤šèµ„æ–™ï¼Œä½†æ˜¯è½®åˆ°è‡ªå·±å»æ•´ç†å»æ€»ç»“çš„æ—¶å€™ï¼Œå‘ç°è¿˜æ˜¯è¦å¤šçœ‹å‡ éèµ„æ–™æ‰èƒ½å®Œå…¨ç†è§£ã€‚è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹å°±æ˜¯ï¼Œç”»å›¾æ˜¯åŠ æ·±å°è±¡å’Œæ£€éªŒè‡ªå·±æ˜¯å¦ç†è§£çš„ä¸€ä¸ªéå¸¸å¥½çš„æ–¹æ³•ã€‚

# ä¸€ã€Volatileæ€ä¹ˆå¿µï¼Ÿ

![volatileæ€ä¹ˆå¿µ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dde3afe545eb469c8692189fb90fb771~tplv-k3u1fbpfcp-zoom-1.image)

çœ‹åˆ°è¿™ä¸ªå•è¯ä¸€ç›´ä¸çŸ¥é“æ€ä¹ˆå‘éŸ³

```sh
è‹± [ËˆvÉ’lÉ™taÉªl]  ç¾ [ËˆvÉ‘ËlÉ™tl]

adj. [åŒ–å­¦] æŒ¥å‘æ€§çš„ï¼›ä¸ç¨³å®šçš„ï¼›çˆ†ç‚¸æ€§çš„ï¼›åå¤æ— å¸¸çš„
```

é‚£Javaä¸­volatileåˆæ˜¯å¹²å•¥çš„å‘¢ï¼Ÿ

# äºŒã€Javaä¸­volatileç”¨æ¥å¹²å•¥ï¼Ÿ

- Volatileæ˜¯Javaè™šæ‹Ÿæœºæä¾›çš„`è½»é‡çº§`çš„åŒæ­¥æœºåˆ¶ï¼ˆä¸‰å¤§ç‰¹æ€§ï¼‰
  - ä¿è¯å¯è§æ€§
  - ä¸ä¿è¯åŸå­æ€§
  - ç¦æ­¢æŒ‡ä»¤é‡æ’

è¦ç†è§£ä¸‰å¤§ç‰¹æ€§ï¼Œå°±å¿…é¡»çŸ¥é“Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰ï¼Œé‚£JMMåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

![volatileæ€ä¹ˆå¿µ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cda72b6a62f449faaa79c20649719349~tplv-k3u1fbpfcp-zoom-1.image)

# ä¸‰ã€JMMåˆæ˜¯å•¥ï¼Ÿ

è¿™æ˜¯ä¸€ä»½ç²¾å¿ƒæ€»ç»“çš„Javaå†…å­˜æ¨¡å‹æ€ç»´å¯¼å›¾ï¼Œæ‹¿å»ä¸è°¢ã€‚

![æ‹¿èµ°ä¸è°¢](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d050c227d950470fbbef93a00f039241~tplv-k3u1fbpfcp-zoom-1.image)

![åŸç†å›¾1-Javaå†…å­˜æ¨¡å‹](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc6cc9d5de6f4a858f90bfc7b831b4cc~tplv-k3u1fbpfcp-zoom-1.image)

## 3.1 ä¸ºä»€ä¹ˆéœ€è¦Javaå†…å­˜æ¨¡å‹ï¼Ÿ

> `Why`:å±è”½å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚

JMMæ˜¯Javaå†…å­˜æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯Java Memory Modelï¼Œç®€ç§°JMMï¼Œæœ¬èº«æ˜¯ä¸€ç§æŠ½è±¡çš„æ¦‚å¿µï¼Œå®é™…ä¸Šå¹¶ä¸å­˜åœ¨ï¼Œå®ƒæè¿°çš„æ˜¯ä¸€ç»„è§„åˆ™æˆ–è§„èŒƒï¼Œé€šè¿‡è¿™ç»„è§„èŒƒå®šä¹‰äº†ç¨‹åºä¸­å„ä¸ªå˜é‡ï¼ˆåŒ…æ‹¬å®ä¾‹å­—æ®µï¼Œé™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼‰çš„è®¿é—®æ–¹å¼ã€‚

## 3.2 åˆ°åº•ä»€ä¹ˆæ˜¯Javaå†…å­˜æ¨¡å‹ï¼Ÿ

- 1.å®šä¹‰ç¨‹åºä¸­å„ç§å˜é‡çš„è®¿é—®è§„åˆ™
- 2.æŠŠå˜é‡å€¼å­˜å‚¨åˆ°å†…å­˜çš„åº•å±‚ç»†èŠ‚
- 3.ä»å†…å­˜ä¸­å–å‡ºå˜é‡å€¼çš„åº•å±‚ç»†èŠ‚

## 3.3 Javaå†…å­˜æ¨¡å‹çš„ä¸¤å¤§å†…å­˜æ˜¯å•¥ï¼Ÿ

![åŸç†å›¾2-ä¸¤å¤§å†…å­˜](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89b87f6e8db04a8dbe99416f9ff05ac2~tplv-k3u1fbpfcp-zoom-1.image)

- ä¸»å†…å­˜
  - Javaå †ä¸­å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†
  - å¯¹åº”äºç‰©ç†ç¡¬ä»¶çš„å†…å­˜
- å·¥ä½œå†…å­˜
  - Javaæ ˆä¸­çš„éƒ¨åˆ†åŒºåŸŸ
  - ä¼˜å…ˆå­˜å‚¨äºå¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜

## 3.4 Javaå†…å­˜æ¨¡å‹æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

Javaå†…å­˜æ¨¡å‹çš„å‡ ä¸ªè§„èŒƒï¼š

- 1.æ‰€æœ‰å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜

- 2.ä¸»å†…å­˜æ˜¯è™šæ‹Ÿæœºå†…å­˜çš„ä¸€éƒ¨åˆ†

- 3.æ¯æ¡çº¿ç¨‹æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜

- 4.çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¿å­˜å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬

- 5.çº¿ç¨‹å¯¹å˜é‡çš„æ“ä½œå¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œ
- 6.ä¸åŒçº¿ç¨‹ä¹‹é—´æ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡
- 7.çº¿ç¨‹é—´å˜é‡å€¼çš„ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆ

ç”±äºJVMè¿è¡Œç¨‹åºçš„å®ä½“æ˜¯çº¿ç¨‹ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹åˆ›å»ºæ—¶JVMéƒ½ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªå·¥ä½œå†…å­˜ï¼ˆæœ‰äº›åœ°æ–¹ç§°ä¸ºæ ˆç©ºé—´ï¼‰ï¼Œå·¥ä½œå†…å­˜æ˜¯æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®åŒºåŸŸï¼Œè€ŒJavaå†…å­˜æ¨¡å‹ä¸­è§„å®šæ‰€æœ‰å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼Œä¸»å†…å­˜æ˜¯å…±äº«å†…å­˜åŒºåŸŸï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ï¼Œ`ä½†çº¿ç¨‹å¯¹å˜é‡çš„æ“ä½œï¼ˆè¯»å–èµ‹å€¼ç­‰ï¼‰å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œé¦–å…ˆè¦å°†å˜é‡ä»ä¸»å†…å­˜æ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ç©ºé—´ï¼Œç„¶åå¯¹å˜é‡è¿›è¡Œæ“ä½œï¼Œæ“ä½œå®Œæˆåå†å°†å˜é‡å†™ä¼šä¸»å†…å­˜`ï¼Œä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œå„ä¸ªçº¿ç¨‹ä¸­çš„å·¥ä½œå†…å­˜ä¸­å­˜å‚¨ç€ä¸»å†…å­˜ä¸­çš„å˜é‡å‰¯æœ¬æ‹·è´ï¼Œå› æ­¤ä¸åŒçš„çº¿ç¨‹é—´æ— æ³•è®¿é—®å¯¹æ–¹çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹é—´çš„é€šä¿¡ï¼ˆä¼ å€¼ï¼‰å¿…é¡»é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆï¼Œå…¶ç®€è¦è®¿é—®è¿‡ç¨‹ï¼š

![åŸç†å›¾3-Javaå†…å­˜æ¨¡å‹](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ebd1754a928408b9228db964bac49a8~tplv-k3u1fbpfcp-zoom-1.image)

## 3.5 Javaå†…å­˜æ¨¡å‹çš„ä¸‰å¤§ç‰¹æ€§

- å¯è§æ€§ï¼ˆå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼æ—¶ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³å¾—çŸ¥è¿™ä¸ªä¿®æ”¹ï¼‰
- åŸå­æ€§ï¼ˆä¸€ä¸ªæ“ä½œæˆ–ä¸€ç³»åˆ—æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ï¼‰
- æœ‰åºæ€§ï¼ˆå˜é‡èµ‹å€¼æ“ä½œçš„é¡ºåºä¸ç¨‹åºä»£ç ä¸­çš„æ‰§è¡Œé¡ºåºä¸€è‡´ï¼‰

å…³äºæœ‰åºæ€§ï¼šå¦‚æœåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚å‰åŠå¥æ˜¯æŒ‡â€œçº¿ç¨‹å†…ä¼¼è¡¨ç°ä¸ºä¸²è¡Œçš„è¯­ä¹‰â€ï¼ˆWithin-Thread As-If-Serial Semanticsï¼‰ï¼ŒååŠå¥æ˜¯æŒ‡â€œæŒ‡ä»¤é‡æ’åºâ€ç°è±¡å’Œâ€œå·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜åŒæ­¥å»¶è¿Ÿâ€ç°è±¡ã€‚

# å››ã€èƒ½ç»™ä¸ªç¤ºä¾‹è¯´ä¸‹æ€ä¹ˆç”¨volatileçš„å—ï¼Ÿ

è€ƒè™‘ä¸€ä¸‹è¿™ç§åœºæ™¯ï¼š

> æœ‰ä¸€ä¸ªå¯¹è±¡çš„å­—æ®µ`number`åˆå§‹åŒ–å€¼=0ï¼Œå¦å¤–è¿™ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå…¬å…±æ–¹æ³•`setNumberTo100()`å¯ä»¥è®¾ç½®number = 100ï¼Œå½“ä¸»çº¿ç¨‹é€šè¿‡å­çº¿ç¨‹æ¥è°ƒç”¨`setNumberTo100()`åï¼Œä¸»çº¿ç¨‹æ˜¯å¦çŸ¥é“numberå€¼å˜äº†å‘¢ï¼Ÿ
>
> ç­”æ¡ˆï¼šå¦‚æœæ²¡æœ‰ä½¿ç”¨volatileæ¥å®šä¹‰numberå˜é‡ï¼Œåˆ™ä¸»çº¿ç¨‹ä¸çŸ¥é“å­çº¿ç¨‹æ›´æ–°äº†numberçš„å€¼ã€‚

ï¼ˆ1ï¼‰å®šä¹‰å¦‚ä¸Šè¿°æ‰€è¯´çš„å¯¹è±¡ï¼š`ShareData`

``` java
class ShareData {
    int number = 0;

    public void setNumberTo100() {
        this.number = 100;
    }
}
```

ï¼ˆ2ï¼‰ä¸»çº¿ç¨‹ä¸­åˆå§‹åŒ–ä¸€ä¸ªå­çº¿ç¨‹ï¼Œåå­—å«åš`å­çº¿ç¨‹`

å­çº¿ç¨‹å…ˆä¼‘çœ 3sï¼Œç„¶åè®¾ç½®number=100ã€‚ä¸»çº¿ç¨‹ä¸æ–­æ£€æµ‹çš„numberå€¼æ˜¯å¦ç­‰äº0ï¼Œå¦‚æœä¸ç­‰äº0ï¼Œåˆ™é€€å‡ºä¸»çº¿ç¨‹ã€‚

```java
public class volatileVisibility {
    public static void main(String[] args) {
        // èµ„æºç±»
        ShareData shareData = new ShareData();

        // å­çº¿ç¨‹ å®ç°äº†Runnableæ¥å£çš„ï¼Œlambdaè¡¨è¾¾å¼
        new Thread(() -> {

            System.out.println(Thread.currentThread().getName() + "\t come in");

            // çº¿ç¨‹ç¡çœ 3ç§’ï¼Œå‡è®¾åœ¨è¿›è¡Œè¿ç®—
            try {
                TimeUnit.SECONDS.sleep(3);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            // ä¿®æ”¹numberçš„å€¼
            myData.setNumberTo100();

            // è¾“å‡ºä¿®æ”¹åçš„å€¼
            System.out.println(Thread.currentThread().getName() + "\t update number value:" + myData.number);

        }, "å­çº¿ç¨‹").start();

        while(myData.number == 0) {
            // mainçº¿ç¨‹å°±ä¸€ç›´åœ¨è¿™é‡Œç­‰å¾…å¾ªç¯ï¼Œç›´åˆ°numberçš„å€¼ä¸ç­‰äºé›¶
        }

        // æŒ‰é“ç†è¿™ä¸ªå€¼æ˜¯ä¸å¯èƒ½æ‰“å°å‡ºæ¥çš„ï¼Œå› ä¸ºä¸»çº¿ç¨‹è¿è¡Œçš„æ—¶å€™ï¼Œnumberçš„å€¼ä¸º0ï¼Œæ‰€ä»¥ä¸€ç›´åœ¨å¾ªç¯
        // å¦‚æœèƒ½è¾“å‡ºè¿™å¥è¯ï¼Œè¯´æ˜å­çº¿ç¨‹åœ¨ç¡çœ 3ç§’åï¼Œæ›´æ–°çš„numberçš„å€¼ï¼Œé‡æ–°å†™å…¥åˆ°ä¸»å†…å­˜ï¼Œå¹¶è¢«mainçº¿ç¨‹æ„ŸçŸ¥åˆ°äº†
        System.out.println(Thread.currentThread().getName() + "\t ä¸»çº¿ç¨‹æ„ŸçŸ¥åˆ°äº† number ä¸ç­‰äº 0");

        /**
         * æœ€åè¾“å‡ºç»“æœï¼š
         * å­çº¿ç¨‹     come in
         * å­çº¿ç¨‹     update number value:100
         * æœ€åçº¿ç¨‹æ²¡æœ‰åœæ­¢ï¼Œå¹¶è¡Œæ²¡æœ‰è¾“å‡º"ä¸»çº¿ç¨‹çŸ¥é“äº† number ä¸ç­‰äº0"è¿™å¥è¯ï¼Œè¯´æ˜æ²¡æœ‰ç”¨volatileä¿®é¥°çš„å˜é‡ï¼Œå˜é‡çš„æ›´æ–°æ˜¯ä¸å¯è§çš„
         */
    }
}
```

![æ²¡æœ‰ä½¿ç”¨volatile](http://cdn.jayh.club/uPic/86c6a9423ef14ad8858005edd9911bc4~tplv-k3u1fbpfcp-zoom-11kBydC.image)

ï¼ˆ3ï¼‰æˆ‘ä»¬ç”¨volatileä¿®é¥°å˜é‡number

```
class ShareData {
    //volatile ä¿®é¥°çš„å…³é”®å­—ï¼Œæ˜¯ä¸ºäº†å¢åŠ å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å†…å­˜ä¸­çš„å€¼ï¼Œå…¶å®ƒçº¿ç¨‹ä¹Ÿèƒ½é©¬ä¸Šæ„ŸçŸ¥
    volatile int number = 0;

    public void setNumberTo100() {
        this.number = 100;
    }
}
```

è¾“å‡ºç»“æœï¼š

``` sh
å­çº¿ç¨‹	 come in
å­çº¿ç¨‹	 update number value:100
main	 ä¸»çº¿ç¨‹çŸ¥é“äº† number ä¸ç­‰äº 0

Process finished with exit code 0
```

![](http://cdn.jayh.club/uPic/152ad1bf389d4cca8f2ed1954a1ca6d9~tplv-k3u1fbpfcp-zoom-1zv8nE2.image)



**å°ç»“ï¼šè¯´æ˜ç”¨volatileä¿®é¥°çš„å˜é‡ï¼Œå½“æŸçº¿ç¨‹æ›´æ–°å˜é‡åï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿèƒ½æ„ŸçŸ¥åˆ°ã€‚**

# äº”ã€é‚£ä¸ºä»€ä¹ˆå…¶ä»–çº¿ç¨‹èƒ½æ„ŸçŸ¥åˆ°å˜é‡æ›´æ–°ï¼Ÿ

![mark](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e169735022884ec59e063a8f85a9aa02~tplv-k3u1fbpfcp-zoom-1.image)

å…¶å®è¿™é‡Œå°±æ˜¯ç”¨åˆ°äº†â€œçª¥æ¢ï¼ˆsnoopingï¼‰â€åè®®ã€‚åœ¨è¯´â€œçª¥æ¢ï¼ˆsnoopingï¼‰â€åè®®ä¹‹å‰ï¼Œé¦–å…ˆè°ˆè°ˆç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ã€‚

## 5.1 ç¼“å­˜ä¸€è‡´æ€§

å½“å¤šä¸ªCPUæŒæœ‰çš„ç¼“å­˜éƒ½æ¥è‡ªåŒä¸€ä¸ªä¸»å†…å­˜çš„æ‹·è´ï¼Œå½“æœ‰å…¶ä»–CPUå·å·æ”¹äº†è¿™ä¸ªä¸»å†…å­˜æ•°æ®åï¼Œå…¶ä»–CPUå¹¶ä¸çŸ¥é“ï¼Œé‚£æ‹·è´çš„å†…å­˜å°†ä¼šå’Œä¸»å†…å­˜ä¸ä¸€è‡´ï¼Œè¿™å°±æ˜¯ç¼“å­˜ä¸ä¸€è‡´ã€‚é‚£æˆ‘ä»¬å¦‚ä½•æ¥ä¿è¯ç¼“å­˜ä¸€è‡´å‘¢ï¼Ÿè¿™é‡Œå°±éœ€è¦æ“ä½œç³»ç»Ÿæ¥å…±åŒåˆ¶å®šä¸€ä¸ªåŒæ­¥è§„åˆ™æ¥ä¿è¯ï¼Œè€Œè¿™ä¸ªè§„åˆ™å°±æœ‰MESIåè®®ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒCPU2 å·å·å°†numä¿®æ”¹ä¸º2ï¼Œå†…å­˜ä¸­numä¹Ÿè¢«ä¿®æ”¹ä¸º2ï¼Œä½†æ˜¯CPU1å’ŒCPU3å¹¶ä¸çŸ¥é“numå€¼å˜äº†ã€‚

![åŸç†å›¾4-ç¼“å­˜ä¸€è‡´æ€§1](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a417fa0a7ce4a71831cd0298ee547f0~tplv-k3u1fbpfcp-zoom-1.image)

## 5.2 MESI

å½“CPUå†™æ•°æ®æ—¶ï¼Œå¦‚æœå‘ç°æ“ä½œçš„å˜é‡æ˜¯å…±äº«å˜é‡ï¼Œå³åœ¨å…¶å®ƒCPUä¸­ä¹Ÿå­˜åœ¨è¯¥å˜é‡çš„å‰¯æœ¬ï¼Œç³»ç»Ÿä¼šå‘å‡ºä¿¡å·é€šçŸ¥å…¶å®ƒCPUå°†è¯¥å†…å­˜å˜é‡çš„`ç¼“å­˜è¡Œ`è®¾ç½®ä¸ºæ— æ•ˆã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒCPU1å’ŒCPU3 ä¸­num=1å·²ç»å¤±æ•ˆäº†ã€‚

![åŸç†å›¾5-ç¼“å­˜ä¸€è‡´æ€§2](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d37038e491ef475f9a0bd722f2780ec1~tplv-k3u1fbpfcp-zoom-1.image)

å½“å…¶å®ƒCPUè¯»å–è¿™ä¸ªå˜é‡çš„æ—¶ï¼Œå‘ç°è‡ªå·±ç¼“å­˜è¯¥å˜é‡çš„ç¼“å­˜è¡Œæ˜¯æ— æ•ˆçš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šä»å†…å­˜ä¸­é‡æ–°è¯»å–ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒCPU1å’ŒCPU3å‘ç°ç¼“å­˜çš„numå€¼å¤±æ•ˆäº†ï¼Œå°±é‡æ–°ä»å†…å­˜è¯»å–ï¼Œnumå€¼æ›´æ–°ä¸º2ã€‚

![åŸç†å›¾6-ç¼“å­˜ä¸€è‡´æ€§3](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e4d0753f39524f6ea4f4445ed0e50354~tplv-k3u1fbpfcp-zoom-1.image)

## 5.3 æ€»çº¿å—…æ¢

é‚£å…¶ä»–CPUæ˜¯æ€ä¹ˆçŸ¥é“è¦å°†ç¼“å­˜æ›´æ–°ä¸ºå¤±æ•ˆçš„å‘¢ï¼Ÿè¿™é‡Œæ˜¯ç”¨åˆ°äº†æ€»çº¿å—…æ¢æŠ€æœ¯ã€‚

æ¯ä¸ªCPUä¸æ–­å—…æ¢æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜å€¼æ˜¯å¦è¿‡æœŸäº†ï¼Œå¦‚æœå¤„ç†å™¨å‘ç°è‡ªå·±çš„ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€è¢«ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®ä¸ºæ— æ•ˆçŠ¶æ€ï¼Œå½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šé‡æ–°ä»å†…å­˜ä¸­æŠŠæ•°æ®è¯»å–åˆ°å¤„ç†å™¨ç¼“å­˜ä¸­ã€‚

![åŸç†å›¾7-ç¼“å­˜ä¸€è‡´æ€§4](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f223f7805e3343f483b9aed3e3bad77a~tplv-k3u1fbpfcp-zoom-1.image)

## 5.4 æ€»çº¿é£æš´

æ€»çº¿å—…æ¢æŠ€æœ¯æœ‰å“ªäº›ç¼ºç‚¹ï¼Ÿ

ç”±äºMESIç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œéœ€è¦ä¸æ–­å¯¹ä¸»çº¿è¿›è¡Œå†…å­˜å—…æ¢ï¼Œå¤§é‡çš„äº¤äº’ä¼šå¯¼è‡´æ€»çº¿å¸¦å®½è¾¾åˆ°å³°å€¼ã€‚å› æ­¤ä¸è¦æ»¥ç”¨volatileï¼Œå¯ä»¥ç”¨é”æ¥æ›¿ä»£ï¼Œçœ‹åœºæ™¯å•¦~

# å…­ã€èƒ½æ¼”ç¤ºä¸‹volatileä¸ºä»€ä¹ˆä¸ä¿è¯åŸå­æ€§å—ï¼Ÿ

åŸå­æ€§ï¼šä¸€ä¸ªæ“ä½œæˆ–ä¸€ç³»åˆ—æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚

**è¿™ä¸ªå®šä¹‰å’Œvolatileå•¥å…³ç³»å‘€ï¼Œå®Œå…¨ä¸èƒ½ç†è§£å‘€ï¼ŸShow me the code!**

è€ƒè™‘ä¸€ä¸‹è¿™ç§åœºæ™¯: 

> å½“20ä¸ªçº¿ç¨‹åŒæ—¶ç»™numberè‡ªå¢1ï¼Œæ‰§è¡Œ1000æ¬¡ä»¥åï¼Œnumberçš„å€¼ä¸ºå¤šå°‘å‘¢ï¼Ÿ

åœ¨å•çº¿ç¨‹çš„åœºæ™¯ï¼Œç­”æ¡ˆæ˜¯20000ï¼Œå¦‚æœæ˜¯å¤šçº¿ç¨‹çš„åœºæ™¯ä¸‹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯èƒ½æ˜¯20000ï¼Œä½†å¾ˆå¤šæƒ…å†µä¸‹éƒ½æ˜¯å°äº20000ã€‚

ç¤ºä¾‹ä»£ç ï¼š

``` java
package com.jackson0714.passjava.threads;

/**
 æ¼”ç¤ºvolatile ä¸ä¿è¯åŸå­æ€§
 * @create: 2020-08-13 09:53
 */

public class VolatileAtomicity {
    public static volatile int number = 0;

    public static void increase() {
        number++;
    }

    public static void main(String[] args) {

        for (int i = 0; i < 50; i++) {
            new Thread(() -> {
                for (int j = 0; j < 1000; j++) {
                    increase();
                }
            }, String.valueOf(i)).start();
        }

        // å½“æ‰€æœ‰ç´¯åŠ çº¿ç¨‹éƒ½ç»“æŸ
        while(Thread.activeCount() > 2) {
            Thread.yield();
        }

        System.out.println(number);
    }
}
```

æ‰§è¡Œç»“æœï¼šç¬¬ä¸€æ¬¡19144ï¼Œç¬¬äºŒæ¬¡20000ï¼Œç¬¬ä¸‰æ¬¡19378ã€‚

![volatileç¬¬ä¸€æ¬¡æ‰§è¡Œç»“æœ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bff5ef10299147c3a1e13196a3dd87e5~tplv-k3u1fbpfcp-zoom-1.image)

![volatileç¬¬äºŒæ¬¡æ‰§è¡Œç»“æœ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9b0b142030844e08a6b674194942321a~tplv-k3u1fbpfcp-zoom-1.image)

![volatileç¬¬ä¸‰æ¬¡æ‰§è¡Œç»“æœ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f305dab9b3a142429a547af37f8e8d3a~tplv-k3u1fbpfcp-zoom-1.image)

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹increase()æ–¹æ³•ï¼Œé€šè¿‡åç¼–è¯‘å·¥å…·javapå¾—åˆ°å¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š

``` java
  public static void increase();
    Code:
       0: getstatic     #2                  // Field number:I
       3: iconst_1
       4: iadd
       5: putstatic     #2                  // Field number:I
       8: return
```

number++å…¶å®æ‰§è¡Œäº†`3æ¡æŒ‡ä»¤`ï¼š

> getstaticï¼šæ‹¿numberçš„åŸå§‹å€¼
> iaddï¼šè¿›è¡ŒåŠ 1æ“ä½œ
> putfieldï¼šæŠŠåŠ 1åçš„å€¼å†™å›

æ‰§è¡Œäº†getstaticæŒ‡ä»¤numberçš„å€¼å–åˆ°æ“ä½œæ ˆé¡¶æ—¶ï¼Œvolatileå…³é”®å­—ä¿è¯äº†numberçš„å€¼åœ¨æ­¤æ—¶æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œiconst_1ã€iaddè¿™äº›æŒ‡ä»¤çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½å·²ç»æŠŠnumberçš„å€¼æ”¹å˜äº†ï¼Œè€Œæ“ä½œæ ˆé¡¶çš„å€¼å°±å˜æˆäº†è¿‡æœŸçš„æ•°æ®ï¼Œæ‰€ä»¥putstaticæŒ‡ä»¤æ‰§è¡Œåå°±å¯èƒ½æŠŠè¾ƒå°çš„numberå€¼åŒæ­¥å›ä¸»å†…å­˜ä¹‹ä¸­ã€‚

æ€»ç»“å¦‚ä¸‹ï¼š

> åœ¨æ‰§è¡Œnumber++è¿™è¡Œä»£ç æ—¶ï¼Œå³ä½¿ä½¿ç”¨volatileä¿®é¥°numberå˜é‡ï¼Œåœ¨æ‰§è¡ŒæœŸé—´ï¼Œè¿˜æ˜¯æœ‰å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œæ²¡æœ‰ä¿è¯åŸå­æ€§ã€‚

# ä¸ƒã€æ€ä¹ˆä¿è¯è¾“å‡ºç»“æœæ˜¯20000å‘¢ï¼Ÿ

## 7.1 synchronizedåŒæ­¥ä»£ç å—

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨synchronizedåŒæ­¥ä»£ç å—æ¥ä¿è¯åŸå­æ€§ã€‚ä»è€Œä½¿ç»“æœç­‰äº20000

``` java
public synchronized static void increase() {
   number++;
}
```

![synchronizedåŒæ­¥ä»£ç å—æ‰§è¡Œç»“æœ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d243dd328ccd4b7781d7bd404e3a2f72~tplv-k3u1fbpfcp-zoom-1.image)

ä½†æ˜¯ä½¿ç”¨synchronizedå¤ªé‡äº†ï¼Œä¼šé€ æˆé˜»å¡ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥åˆ°è¿™ä¸ªæ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Javaå¹¶å‘åŒ…ï¼ˆJUCï¼‰ä¸­çš„AtomicIntergerå·¥å…·åŒ…ã€‚

## 7.2 AtomicIntergeråŸå­æ€§æ“ä½œ

æˆ‘ä»¬æ¥çœ‹çœ‹AtomicIntergeråŸå­è‡ªå¢çš„æ–¹æ³•getAndIncrement()

![AtomicInterger](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c22baed8800455798cd99aed6e68a5f~tplv-k3u1fbpfcp-zoom-1.image)

```java
public static AtomicInteger atomicInteger = new AtomicInteger();

public static void main(String[] args) {

    for (int i = 0; i < 20; i++) {
        new Thread(() -> {
            for (int j = 0; j < 1000; j++) {
                atomicInteger.getAndIncrement();
            }
        }, String.valueOf(i)).start();
    }

    // å½“æ‰€æœ‰ç´¯åŠ çº¿ç¨‹éƒ½ç»“æŸ
    while(Thread.activeCount() > 2) {
        Thread.yield();
    }

    System.out.println(atomicInteger);
}
```

å¤šæ¬¡è¿è¡Œçš„ç»“æœéƒ½æ˜¯20000ã€‚

![getAndIncrementçš„æ‰§è¡Œç»“æœ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d98fc8f2ee3c4ebe9dd7a30cee1cab18~tplv-k3u1fbpfcp-zoom-1.image)



# å…«ã€ç¦æ­¢æŒ‡ä»¤é‡æ’åˆæ˜¯å•¥ï¼Ÿ

è¯´åˆ°æŒ‡ä»¤é‡æ’å°±å¾—çŸ¥é“ä¸ºä»€ä¹ˆè¦é‡æ’ï¼Œæœ‰å“ªå‡ ç§é‡æ’ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæŒ‡ä»¤æ‰§è¡Œé¡ºåºæ˜¯æŒ‰ç…§1>2>3>4çš„é¡ºåºï¼Œç»è¿‡é‡æ’åï¼Œæ‰§è¡Œé¡ºåºæ›´æ–°ä¸ºæŒ‡ä»¤3->4->2->1ã€‚

![åŸç†å›¾8-æŒ‡ä»¤é‡æ’](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67306ded607144cf8697ccaef3305b4a~tplv-k3u1fbpfcp-zoom-1.image)

ä¼šä¸ä¼šæ„Ÿè§‰åˆ°é‡æ’æŠŠæŒ‡ä»¤é¡ºåºéƒ½æ‰“ä¹±äº†ï¼Œè¿™æ ·å¥½å—ï¼Ÿ

å¯ä»¥å›æƒ³ä¸‹å°å­¦æ—¶å€™çš„æ•°å­¦é¢˜ï¼š`2+3-5=?`ï¼Œå¦‚æœæŠŠè¿ç®—é¡ºåºæ”¹ä¸º`3-5+2=?`ï¼Œç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥æŒ‡ä»¤é‡æ’æ˜¯è¦ä¿è¯å•çº¿ç¨‹ä¸‹ç¨‹åºç»“æœä¸å˜çš„æƒ…å†µä¸‹åšé‡æ’ã€‚

## 8.1 ä¸ºä»€ä¹ˆè¦é‡æ’

è®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºã€‚

## 8.2 æœ‰å“ªå‡ ç§é‡æ’

- 1.ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’ï¼šç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚

- 2.æŒ‡ä»¤çº§çš„å¹¶è¡Œé‡æ’ï¼šç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚

- 3.å†…å­˜ç³»ç»Ÿçš„é‡æ’ï¼šç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯»/å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œã€‚

![åŸç†å›¾9-ä¸‰ç§é‡æ’](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60ea5804fd9e43aa8a1205e1988645b4~tplv-k3u1fbpfcp-zoom-1.image)

æ³¨æ„ï¼š

- å•çº¿ç¨‹ç¯å¢ƒé‡Œé¢ç¡®ä¿æœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºçš„ç»“æœä¸€è‡´

- å¤„ç†å™¨åœ¨è¿›è¡Œé‡æ’åºæ—¶ï¼Œå¿…é¡»è¦è€ƒè™‘æŒ‡ä»¤ä¹‹é—´çš„`æ•°æ®ä¾èµ–æ€§`

- å¤šçº¿ç¨‹ç¯å¢ƒä¸­çº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’çš„å­˜åœ¨ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„å˜é‡èƒ½å¦ä¿è¯ä¸€è‡´æ€§æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œç»“æœæ— æ³•é¢„æµ‹ã€‚

## 8.3 ä¸¾ä¸ªä¾‹å­æ¥è¯´è¯´å¤šçº¿ç¨‹ä¸­çš„æŒ‡ä»¤é‡æ’ï¼Ÿ

è®¾æƒ³ä¸€ä¸‹è¿™ç§åœºæ™¯ï¼šå®šä¹‰äº†å˜é‡num=0å’Œå˜é‡flag=falseï¼Œçº¿ç¨‹1è°ƒç”¨åˆå§‹åŒ–å‡½æ•°init()æ‰§è¡Œåï¼Œçº¿ç¨‹è°ƒç”¨add()æ–¹æ³•ï¼Œå½“å¦å¤–çº¿ç¨‹åˆ¤æ–­flag=trueåï¼Œæ‰§è¡Œnum+100æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬é¢„æœŸçš„ç»“æœæ˜¯numä¼šç­‰äº101ï¼Œä½†å› ä¸ºæœ‰æŒ‡ä»¤é‡æ’çš„å¯èƒ½ï¼Œnum=1å’Œflag=trueæ‰§è¡Œé¡ºåºå¯èƒ½ä¼šé¢ å€’ï¼Œä»¥è‡³äºnumå¯èƒ½ç­‰äº100

```java
public class VolatileResort {
    static int num = 0;
    static boolean flag = false;
    public static void init() {
        num= 1;
        flag = true;
    }
    public static void add() {
        if (flag) {
            num = num + 5;
            System.out.println("num:" + num);
        }
    }
    public static void main(String[] args) {
        init();
        new Thread(() -> {
            add();
        },"å­çº¿ç¨‹").start();
    }
}

```

å…ˆçœ‹çº¿ç¨‹1ä¸­æŒ‡ä»¤é‡æ’ï¼š

`num= 1;flag = true;` çš„æ‰§è¡Œé¡ºåºå˜ä¸º` flag=true;num = 1;`ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ—¶åºå›¾

![åŸç†å›¾10-çº¿ç¨‹1æŒ‡ä»¤é‡æ’](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ca92ba4f6fb48afb5416b5558df436e~tplv-k3u1fbpfcp-zoom-1.image)

å¦‚æœçº¿ç¨‹2 num=num+5 åœ¨çº¿ç¨‹1è®¾ç½®num=1ä¹‹å‰æ‰§è¡Œï¼Œé‚£ä¹ˆçº¿ç¨‹2çš„numå˜é‡å€¼ä¸º5ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ—¶åºå›¾ã€‚

![åŸç†å›¾11-çº¿ç¨‹2åœ¨num=1ä¹‹å‰æ‰§è¡Œ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f4541a9372b94cc68175d12f9734b191~tplv-k3u1fbpfcp-zoom-1.image)

## 8.4 volatileæ€ä¹ˆå®ç°ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Ÿ

æˆ‘ä»¬ä½¿ç”¨volatileå®šä¹‰flagå˜é‡ï¼š

```java
static volatile boolean flag = false;
```

**å¦‚ä½•å®ç°ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼š**

åŸç†ï¼šåœ¨volatileç”Ÿæˆçš„æŒ‡ä»¤åºåˆ—å‰åæ’å…¥`å†…å­˜å±éšœ`ï¼ˆMemory Barriesï¼‰æ¥ç¦æ­¢å¤„ç†å™¨é‡æ’åºã€‚

**æœ‰å¦‚ä¸‹å››ç§å†…å­˜å±éšœï¼š**

![å››ç§å†…å­˜å±éšœ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9eb55cfc2514d5b967005c9591ea433~tplv-k3u1fbpfcp-zoom-1.image)

**volatileå†™çš„åœºæ™¯å¦‚ä½•æ’å…¥å†…å­˜å±éšœï¼š**

- åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ªStoreStoreå±éšœï¼ˆå†™-å†™ å±éšœï¼‰ã€‚

- åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªStoreLoadå±éšœï¼ˆå†™-è¯» å±éšœï¼‰ã€‚

![åŸç†å›¾12-volatileå†™çš„åœºæ™¯å¦‚ä½•æ’å…¥å†…å­˜å±éšœ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d4909f2b35745839b92ddee883774a3~tplv-k3u1fbpfcp-zoom-1.image)

> StoreStoreå±éšœå¯ä»¥ä¿è¯åœ¨volatileå†™ï¼ˆflagèµ‹å€¼æ“ä½œflag=trueï¼‰ä¹‹å‰ï¼Œå…¶å‰é¢çš„æ‰€æœ‰æ™®é€šå†™ï¼ˆnumçš„èµ‹å€¼æ“ä½œnum=1) æ“ä½œå·²ç»å¯¹ä»»æ„å¤„ç†å™¨å¯è§äº†ï¼Œä¿éšœæ‰€æœ‰æ™®é€šå†™åœ¨volatileå†™ä¹‹å‰åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚

**volatileè¯»åœºæ™¯å¦‚ä½•æ’å…¥å†…å­˜å±éšœï¼š**

- åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadLoadå±éšœï¼ˆè¯»-è¯» å±éšœï¼‰ã€‚

- åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadStoreå±éšœï¼ˆè¯»-å†™ å±éšœï¼‰ã€‚

![åŸç†å›¾13-volatileè¯»åœºæ™¯å¦‚ä½•æ’å…¥å†…å­˜å±éšœ](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/abe11d4910354a019053d9cab3440818~tplv-k3u1fbpfcp-zoom-1.image)

> LoadStoreå±éšœå¯ä»¥ä¿è¯å…¶åé¢çš„æ‰€æœ‰æ™®é€šå†™ï¼ˆnumçš„èµ‹å€¼æ“ä½œnum=num+5) æ“ä½œå¿…é¡»åœ¨volatileè¯»ï¼ˆif(flag)ï¼‰ä¹‹åæ‰§è¡Œã€‚

# åã€volatileå¸¸è§åº”ç”¨

è¿™é‡Œä¸¾ä¸€ä¸ªåº”ç”¨ï¼ŒåŒé‡æ£€æµ‹é”å®šçš„å•ä¾‹æ¨¡å¼

```java
package com.jackson0714.passjava.threads;
/**
 æ¼”ç¤ºvolatile å•ä¾‹æ¨¡å¼åº”ç”¨ï¼ˆåŒè¾¹æ£€æµ‹ï¼‰
 * @author: æ‚Ÿç©ºèŠæ¶æ„
 * @create: 2020-08-17
 */

class VolatileSingleton {
    private static VolatileSingleton instance = null;
    private VolatileSingleton() {
        System.out.println(Thread.currentThread().getName() + "\t æˆ‘æ˜¯æ„é€ æ–¹æ³•SingletonDemo");
    }
    public static VolatileSingleton getInstance() {
        // ç¬¬ä¸€é‡æ£€æµ‹
        if(instance == null) {
            // é”å®šä»£ç å—
            synchronized (VolatileSingleton.class) {
                // ç¬¬äºŒé‡æ£€æµ‹
                if(instance == null) {
                    // å®ä¾‹åŒ–å¯¹è±¡
                    instance = new VolatileSingleton();
                }
            }
        }
        return instance;
    }
}
```

ä»£ç çœ‹èµ·æ¥æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ `instance = new VolatileSingleton();`å…¶å®å¯ä»¥çœ‹ä½œä¸‰æ¡ä¼ªä»£ç ï¼š

``` java
memory = allocate(); // 1ã€åˆ†é…å¯¹è±¡å†…å­˜ç©ºé—´
instance(memory); // 2ã€åˆå§‹åŒ–å¯¹è±¡
instance = memory; // 3ã€è®¾ç½®instanceæŒ‡å‘åˆšåˆšåˆ†é…çš„å†…å­˜åœ°å€ï¼Œæ­¤æ—¶instance != null
```

æ­¥éª¤2 å’Œ æ­¥éª¤3ä¹‹é—´ä¸å­˜åœ¨ æ•°æ®ä¾èµ–å…³ç³»ï¼Œè€Œä¸”æ— è®ºé‡æ’å‰ è¿˜æ˜¯é‡æ’åï¼Œç¨‹åºçš„æ‰§è¡Œç»“æœåœ¨å•çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤è¿™ç§é‡æ’ä¼˜åŒ–æ˜¯å…è®¸çš„ã€‚

```java
memory = allocate(); // 1ã€åˆ†é…å¯¹è±¡å†…å­˜ç©ºé—´
instance = memory; // 3ã€è®¾ç½®instanceæŒ‡å‘åˆšåˆšåˆ†é…çš„å†…å­˜åœ°å€ï¼Œæ­¤æ—¶instance != nullï¼Œä½†æ˜¯å¯¹è±¡è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆ
instance(memory); // 2ã€åˆå§‹åŒ–å¯¹è±¡
```

å¦‚æœå¦å¤–ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼š`if(instance == null) `æ—¶ï¼Œåˆ™è¿”å›åˆšåˆšåˆ†é…çš„å†…å­˜åœ°å€ï¼Œä½†æ˜¯å¯¹è±¡è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆï¼Œæ‹¿åˆ°çš„instanceæ˜¯ä¸ªå‡çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![åŸç†å›¾14-åŒé‡æ£€é”å­˜åœ¨çš„å¹¶å‘é—®é¢˜](//p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/679b71b5add94fd282dff8e6cc45e198~tplv-k3u1fbpfcp-zoom-1.image)

è§£å†³æ–¹æ¡ˆï¼šå®šä¹‰instanceä¸ºvolatileå˜é‡

```java
private static volatile VolatileSingleton instance = null;
```

# åä¸€ã€volatileéƒ½ä¸ä¿è¯åŸå­æ€§ï¼Œä¸ºå•¥æˆ‘ä»¬è¿˜è¦ç”¨å®ƒï¼Ÿ

å¥‡æ€ªçš„æ˜¯ï¼Œvolatileéƒ½ä¸ä¿è¯åŸå­æ€§ï¼Œä¸ºå•¥æˆ‘ä»¬è¿˜è¦ç”¨å®ƒï¼Ÿ

volatileæ˜¯è½»é‡çº§çš„åŒæ­¥æœºåˆ¶ï¼Œå¯¹æ€§èƒ½çš„å½±å“æ¯”synchronizedå°ã€‚

> å…¸å‹çš„ç”¨æ³•ï¼šæ£€æŸ¥æŸä¸ªçŠ¶æ€æ ‡è®°ä»¥åˆ¤æ–­æ˜¯å¦é€€å‡ºå¾ªç¯ã€‚

æ¯”å¦‚çº¿ç¨‹è¯•å›¾é€šè¿‡ç±»ä¼¼äºæ•°ç»µç¾Šçš„ä¼ ç»Ÿæ–¹æ³•è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œä¸ºäº†ä½¿è¿™ä¸ªç¤ºä¾‹èƒ½æ­£ç¡®æ‰§è¡Œï¼Œasleepå¿…é¡»ä¸ºvolatileå˜é‡ã€‚å¦åˆ™ï¼Œå½“asleepè¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æ—¶ï¼Œæ‰§è¡Œåˆ¤æ–­çš„çº¿ç¨‹å´å‘ç°ä¸äº†ã€‚

**é‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ç›´æ¥ç”¨synchorizedï¼Œlocké”ï¼Ÿå®ƒä»¬æ—¢å¯ä»¥ä¿è¯å¯è§æ€§ï¼Œåˆå¯ä»¥ä¿è¯åŸå­æ€§ä¸ºä½•ä¸ç”¨å‘¢ï¼Ÿ**

å› ä¸ºsynchorizedå’Œlockæ˜¯æ’ä»–é”ï¼ˆæ‚²è§‚é”ï¼‰ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹éœ€è¦è®¿é—®è¿™ä¸ªå˜é‡ï¼Œå°†ä¼šå‘ç”Ÿç«äº‰ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è¿™ä¸ªå˜é‡ï¼Œå…¶ä»–çº¿ç¨‹è¢«é˜»å¡äº†ï¼Œä¼šå½±å“ç¨‹åºçš„æ€§èƒ½ã€‚

> æ³¨æ„ï¼šå½“ä¸”ä»…å½“æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ—¶ï¼Œæ‰åº”è¯¥ç”¨volatileå˜é‡
>
> - å¯¹å˜é‡çš„å†™å…¥æ“ä½œä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼ï¼Œæˆ–è€…ä½ èƒ½ç¡®ä¿åªæœ‰å•ä¸ªçº¿ç¨‹æ›´æ–°å˜é‡çš„å€¼ã€‚
> - è¯¥å˜é‡ä¸ä¼šä¸å…¶ä»–çš„çŠ¶æ€ä¸€èµ·çº³å…¥ä¸å˜æ€§æ¡ä»¶ä¸­ã€‚
> - åœ¨è®¿é—®å˜é‡æ—¶ä¸éœ€è¦åŠ é”ã€‚

# åäºŒã€volatileå’Œsynchronziedçš„åŒºåˆ«

- volatileåªèƒ½ä¿®é¥°å®ä¾‹å˜é‡å’Œç±»å˜é‡ï¼Œsynchronizedå¯ä»¥ä¿®é¥°æ–¹æ³•å’Œä»£ç å—ã€‚
- volatileä¸ä¿è¯åŸå­æ€§ï¼Œè€Œsynchronizedä¿è¯åŸå­æ€§
- volatile ä¸ä¼šé€ æˆé˜»å¡ï¼Œè€Œsynchronizedå¯èƒ½ä¼šé€ æˆé˜»å¡
- volatile è½»é‡çº§é”ï¼Œsynchronizedé‡é‡çº§é”
- volatile å’Œsynchronizedéƒ½ä¿è¯äº†å¯è§æ€§å’Œæœ‰åºæ€§

# åä¸‰ã€å°ç»“

- volatile ä¿è¯äº†å¯è§æ€§ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼æ—¶ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³å¾—çŸ¥è¿™ä¸ªä¿®æ”¹ã€‚
- volatile ä¿è¯äº†å•çº¿ç¨‹ä¸‹æŒ‡ä»¤ä¸é‡æ’ï¼šé€šè¿‡æ’å…¥å†…å­˜å±éšœä¿è¯æŒ‡ä»¤æ‰§è¡Œé¡ºåºã€‚
- volatitleä¸ä¿è¯åŸå­æ€§ï¼Œå¦‚a++è¿™ç§è‡ªå¢æ“ä½œæ˜¯æœ‰å¹¶å‘é£é™©çš„ï¼Œæ¯”å¦‚æ‰£å‡åº“å­˜ã€å‘æ”¾ä¼˜æƒ åˆ¸çš„åœºæ™¯ã€‚
- volatile ç±»å‹çš„64ä½çš„longå‹å’Œdoubleå‹å˜é‡ï¼Œå¯¹è¯¥å˜é‡çš„è¯»/å†™å…·æœ‰åŸå­æ€§ã€‚
- volatile å¯ä»¥ç”¨åœ¨åŒé‡æ£€é”çš„å•ä¾‹æ¨¡å¼ç§ï¼Œæ¯”synchronizedæ€§èƒ½æ›´å¥½ã€‚
- volatile å¯ä»¥ç”¨åœ¨æ£€æŸ¥æŸä¸ªçŠ¶æ€æ ‡è®°ä»¥åˆ¤æ–­æ˜¯å¦é€€å‡ºå¾ªç¯ã€‚


å‚è€ƒèµ„æ–™ï¼š

ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹

ã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹

ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ 

**æœŸå¾…åç¯‡ä¹ˆï¼ŸCASèµ°èµ·ï¼**


> ä½ å¥½ï¼Œæˆ‘æ˜¯`æ‚Ÿç©ºå“¥`ï¼Œ**ã€Œ7å¹´é¡¹ç›®å¼€å‘ç»éªŒï¼Œå…¨æ ˆå·¥ç¨‹å¸ˆï¼Œå¼€å‘ç»„é•¿ï¼Œè¶…å–œæ¬¢å›¾è§£ç¼–ç¨‹åº•å±‚åŸç†ã€**ã€‚  
> æˆ‘è¿˜`æ‰‹å†™äº† 2 ä¸ªå°ç¨‹åº`ï¼Œ`Java åˆ·é¢˜å°ç¨‹åº`ï¼Œ`PMP åˆ·é¢˜å°ç¨‹åº`ï¼Œç‚¹å‡»æˆ‘çš„å…¬ä¼—å·èœå•æ‰“å¼€ï¼  
> å¦å¤–æœ‰ 111 æœ¬æ¶æ„å¸ˆèµ„æ–™ä»¥åŠ 1000 é“ Java é¢è¯•é¢˜ï¼Œéƒ½æ•´ç†æˆäº†PDFã€‚  
> å¯ä»¥å…³æ³¨å…¬ä¼—å· **ã€Œæ‚Ÿç©ºèŠæ¶æ„ã€** å›å¤ `æ‚Ÿç©º` é¢†å–ä¼˜è´¨èµ„æ–™ã€‚

**ã€Œè½¬å‘->åœ¨çœ‹->ç‚¹èµ->æ”¶è—->è¯„è®ºï¼ï¼ï¼ã€** æ˜¯å¯¹æˆ‘æœ€å¤§çš„æ”¯æŒï¼

**ã€ŠJavaå¹¶å‘å¿…çŸ¥å¿…ä¼šã€‹ç³»åˆ—ï¼š**  

[1.ååˆ¶é¢è¯•å®˜ | 14å¼ åŸç†å›¾ | å†ä¹Ÿä¸æ€•è¢«é—® volatile!](https://juejin.im/post/6861885337568804871)

[2.ç¨‹åºå‘˜æ·±å¤œæƒ¨é­è€å©†é„™è§†ï¼ŒåŸå› ç«Ÿæ˜¯CASåŸç†å¤ªç®€å•ï¼Ÿ](https://juejin.im/post/6863799243182702599)

[3.ç”¨ç§¯æœ¨è®²è§£ABAåŸç† | è€å©†å±…ç„¶åˆå¬æ‡‚äº†ï¼](https://juejin.im/post/6864945088721027079)

[4.å…¨ç½‘æœ€ç»† |  21å¼ å›¾å¸¦ä½ é¢†ç•¥é›†åˆçš„çº¿ç¨‹ä¸å®‰å…¨](https://juejin.im/post/6866444584688451591)         

[5.5000å­— | 24å¼ å›¾å¸¦ä½ å½»åº•ç†è§£Javaä¸­çš„21ç§é”](https://juejin.im/post/6867922895536914446) 

[6.å¹²è´§ | ä¸€å£æ°”è¯´å‡º18ç§é˜Ÿåˆ—(Queue)ï¼Œé¢è¯•ç¨³äº†](https://juejin.im/post/6870298844425371655) 

[è¿™ä¸‰å¹´è¢«åˆ†å¸ƒå¼å‘æƒ¨äº†ï¼Œæ›å…‰åå¤§å‘ | ğŸ† æŠ€æœ¯ä¸“é¢˜ç¬¬äº”æœŸå¾æ–‡](https://juejin.im/editor/drafts/6875738877009592333)