# Redis 帝国的神秘使者到访 C 语言帝国

## 迎接使者大人

“吁····”

这声音从一辆豪华马车中传出，拉车的两匹马儿听到后，立马停在了路边。

“先生，可有什么不对劲？”车夫谨慎地问道。

车中的一位年轻帅小伙拉开了车门前的帘布，说道：“前方有一只百人军队正在赶来，想必是 C 语言帝国的皇家护卫军。”

一小会的功夫，前方百人军队正骑着马来到了马车前。

一名身材魁梧，八尺高，手持一柄长枪的士兵从马背上下来了。

“我是 C 语言帝国的皇家护卫队队长，恭闻先生远道而来出使我国，国王特派我前来迎接使者大人。” 这位队长说道。

“承蒙国王厚爱，那我们路上边走边说吧。”使者说道。

## C 语言帝国大殿

“使者大人，前面就是我国的宫殿了，请小心殿堂内的字符串大臣。”护卫队队长说道。

先生心生疑惑地走进了殿堂中，大家的目光都汇聚到了这位年轻人的身上。他在大殿上给国王行了一个礼。

国王说道：“这是 Redis 帝国派来的使者，他给我们带了一个新的数据结构，叫做`简单动态字符串`，他还有个英文名字，叫做 SDS，全称 simple dynamic string”。

在大殿一旁的字符串大臣，脸色显得略微有点难看。

国王继续说道：“SDS 先生，你一路辛苦了，可以介绍下贵国的 SDS 数据结构吗？”

SDS 使者说：“我和 C 语言大国的字符串不一样，C 语言中字符串是是由`字符数组`组成的，最后一个元素总是空字符 `\0`。” 使者大人向殿内大臣展示了一张示意图：

![](http://cdn.jayh.club/blog/20210713/hEgB1I04r1qv.png?imageslim)

“中文`悟空`的拼音 `wukong` 被放到数组一个长度为 7 的字符数组中，最后一个元素是空字符'\0'。” 使者继续解释道。

旁边的数组大臣和字符串大臣专注地聆听着，好像随时准备发问似的。

SDS 使者说：“我们 Redis 帝国的字符串是用 SDS 表示的，这是在字符数组上进行了增强，是一种新的结构体”

随后使者拿出了一份代码示例：

```c
 struct sdshdr {
    // 字符数组，用于保存字符串
    // 和 C 语言中保存字符串的字符数组一样。
    char buf[];
     
    // 记录 buf 数组中已使用字节的数量，等于 SDS 锁保存字符串的长度。 
 	int len;
     
    // 记录 buf 数组中未使用字节的数量
 	int free;
 }
```

随后 SDS 使者拿出来了一张示例图解释道：

![](http://cdn.jayh.club/blog/20210713/vCXUOTnP9C3g.png?imageslim)

简单动态字符串 SDS 结构是由三部分组成：

- buf 数组属性和 C 语言帝国一样，都用了 7 个字节来保存 wukong，最后一个元素是空字符。
- len 属性这个值为 6，代表这个 SDS 保存了一个 6 字节长的字符串（最后一个空字符不计算 len 属性中）。
- free 属性的值为 0，代表这个 SDS 没有其他剩余空间来存放字符了。

注意：数组中的空字符是自动加到字符串末尾的，由 SDS 的函数自动完成。为什么要和 C 语言的字符串的空字符结尾保持一致呢？是因为这样可以重用一部分 C 字符串函数库里面的函数。

旁边的字符串大臣按捺不住地问道：“你这样做，我看不到什么好处呢？反而增加了空间来保存 free 和 len 属性。”

众人听完字符串大臣的话，都若有所思。

国王看着众人疑惑的脸然后说道：“大家不要着急，且听使者解释。”

“因为我用 len 属性记录了字符串的总长度，所以要是有程序想要访问 SDS 的len 属性，就可以立即知道保存的字符串长度，简单来说就是复杂度为 O(1)。” 使者不紧不慢地说道。

国王将目光投向了字符串大臣，然后说道：“字符串爱卿，我们的 C 字符串计算长度需要多久？”







