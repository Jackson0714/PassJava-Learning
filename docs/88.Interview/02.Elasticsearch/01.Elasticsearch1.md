## 一、ES 慢查询之坑

Elasticsearch 是现如今用的最广泛的搜索引擎。它是一个分布式的开源搜索和分析引擎，适用于所有类型的数据，包括文本、数字、地理空间、结构化和非结构化数据。

### 1.1 工作原理：

**ES 的工作原理**：往 ES 里写数据时，实际是写到磁盘文件，查询时，操作系统会将磁盘文件里的数据自动缓存 `filesystem cache` 里面。如果给 `filesystem cache` 更多的内存，尽量让内存可以容纳所有的 `idx segment file` 索引数据文件，则搜索的时候走内存，性能较好。

![ES 工作原理](http://cdn.jayh.club/uPic/image-20210525181914873.png)

> ` 坑：` 首先如果访问磁盘那一定很慢，而走缓存会快很多。但如果很多没用的字段数据都丢到缓存里面，则会浪费缓存的空间，所以很多数据还是存在磁盘里面的，那么大部分查询走的数据库，则会带来性能问题。

### 1.2 案例

ES 节点 3 台机器，每台机器 32 G 内存，总内存 96 G，给 ES JVM 堆内存是 16 G，那么剩下来给 cache 的是 16 G，总共 ES 集群的的 cache 占用内存 48 G ，如果所有的数据占据磁盘空间 600 G，那么每台机器的数据量是 200 G，而查询时，有 150 G 左右的的数据是走磁盘查询的，那么走 cache 的概率是 48 G/ 600 G = 8%，也就是说大量查询是走磁盘的。

### 1.3 避坑指南：

#### 1.3.1 存储关键信息

![搜索引擎避坑指南](http://cdn.jayh.club/uPic/image-20210525181943400.png)

-   将数据中索引字段存到 cache，比如 一行数据有 name、gender、age、city、job 字段，而检索这条数据只需要 name 和 gender 就可以查询出数据，那么 cache 就只需要存 id、name 和 gender 字段。别把所有字段都丢到 cache 里面，纯属浪费空间，资源是有限的。

-   那剩下的字段怎么检索出来？可以把其他字段存到 mysql/hbase 里面。
-   hbase 特点：适用于海量数据的在线存储。缺点是不能进行复杂的搜索。根据 name 和 gender 字段从 ES 中拿到 100 条数据 ( 包含 doc id ) ，然后根据 doc id 再去 hbase 中查询每个 doc id 对应的完整数据，将结果组装后返回给前端 ( 需要考虑分页的情况 ) 。

#### 1.3.2 数据预热

-   将访问量高的数据或者即将访问量高的数据放到 filesystem cache 里面。
-   每隔一段时间就从数据库访问下数据，然后同步到 filesystem cache 里面。

#### 1.3.3 冷热分离

-   不常访问的数据和经常访问的数据进行隔离。比如 3 台机器存放冷数据的索引，另外 3 台存放热数据的索引。

#### 1.3.4 避免使用关联查询

-   ES 中的关联查询是比较慢的，性能不佳，尽量避免使用。