# Redis 的缓冲区

## 一、为什么要有缓冲区

我们都知道消息队列是用来暂存消息的，这里 Redis 的缓冲区就可以理解为消息队列，用来暂存客户端和服务端端消息。

Redis 的缓冲区就是用一块内存空间来暂时存放命令数据，以免出现因为数据和命令的`处理速度`慢于`发送速度`而导致的`数据丢失`和`性能问题`。

## 二、缓冲区的应用场景

缓冲区在 Redis 中的两个主要应用场景：

- Redis 是client-server 架构，客户端和服务器端之间进行通信时，用来暂存客户端发送的命令数据，或服务器端返回给客户端的数据结果。
- 主从节点间进行数据同步时，用来暂存主节点接收的写命令和数据。

## 三、客户端输入和输出缓冲区

输入缓冲区会先把客户端发送过来的命令暂存起来，Redis 主线程再从输入缓冲区中读取命令，进行处理。当 Redis 主线程处理完数据后，会把结果写入到输出缓冲区，再通过输出缓冲区返回给客户端。

![img](http://cdn.jayh.club/uPic/b86be61e91bd7ca207989c220991fce4.jpg)

### 3.1 输入缓冲区溢出情况

- 写入了 bigkey，比如一下子写入了多个百万级别的集合类型数据；
- 服务器端处理请求的速度过慢，例如，Redis 主线程出现了间歇性阻塞，无法及时处理正常发送的请求，导致客户端发送的请求在缓冲区越积越多。

使用 CLIENT LIST 命令查看和服务器端相连的每个客户端对输入缓冲区的使用情况。

```sh
CLIENT LIST
id=5 addr=127.0.0.1:50487 fd=9 name= age=4 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=26 qbuf-free=32742 obl=0 oll=0 omem=0 events=r cmd=client
```

解决方案：

Redis 并没有提供参数让我们调节客户端输入缓冲区的大小。如果要避免输入缓冲区溢出，那我们就只能从数据命令的发送和处理速度入手，也就是前面提到的避免客户端写入 bigkey，以及避免 Redis 主线程阻塞。

### 3.2 输出缓冲区溢出情况

- 服务器端返回 bigkey 的大量结果。
- 执行了 MONITOR 命令。
- 缓冲区大小设置得不合理。

解决方案：

- 避免 bigkey 操作返回大量数据结果；
- 避免在线上环境中持续使用 MONITOR 监测命令。
- 使用 client-output-buffer-limit 设置合理的缓冲区大小上限，或是缓冲区连续写入时间和写入量上限。

## 四、主从集群中的缓冲区

### 4.1 主从集群的复制方式

- 全量复制：同步所有数据。
- 增量复制：把主从库网络断连期间主库收到的命令，同步给从库。

### 4.2 复制缓冲区

#### 4.2.1 复制缓冲区是什么

在全量复制过程中，主节点在向从节点传输 RDB 文件的同时，会继续接收客户端发送的写命令请求。这些写命令就会先保存在复制缓冲区中，等 RDB 文件传输完成后，再发送给从节点去执行。主节点上会为每个从节点都维护一个复制缓冲区，来保证主从节点间的数据同步。

![](http://cdn.jayh.club/uPic/a39cd9a9f62c547e2069e6977239de7a.jpg)

#### 4.2.2 复制缓冲区溢出

如果在全量复制时，从节点接收和加载 RDB 较慢，同时主节点接收到了大量的写命令，写命令在复制缓冲区中就会越积越多，最终导致溢出。

复制缓冲区溢出会造成什么？

主节点会直接关闭和从节点进行复制操作的连接，导致全量复制失败。

#### 4.2.3 复制缓冲区溢出的解决方案

- 控制主节点保存的数据量大小，并设置合理的复制缓冲区大小。

  ```sh
  config set client-output-buffer-limit slave 512mb 128mb 60
  ```

- 控制从节点的数量，来避免主节点中复制缓冲区占用过多内存的问题。

### 4.3 复制积压缓冲区

增量复制时使用的缓冲区，这个缓冲区称为复制积压缓冲区（repl_backlog_buffer）。

主节点在把接收到的写命令同步给从节点时，同时会把这些写命令写入复制积压缓冲区。一旦从节点发生网络闪断，再次和主节点恢复连接后，从节点就会从复制积压缓冲区中，读取断连期间主节点接收到的写命令，进而进行增量同步，如下图所示：

![](http://cdn.jayh.club/uPic/aedc9b41b31860e283c5d140bdb3318f.jpg)

复制积压缓冲区是一个大小有限的环形缓冲区。当主节点把复制积压缓冲区写满后，会覆盖缓冲区中的旧命令数据。如果从节点还没有同步这些旧命令数据，就会造成主从节点间重新开始执行全量复制。

## 五、总结

### 5.1 缓冲区的用途分类

- 客户端的输入缓冲区。
- 客户端输出缓冲区。
- 主从集群中主节点上的复制缓冲区。
- 主从集群中主节点上复制积压缓冲区。

### 5.2 缓冲区溢出的影响

#### 5.2.1 连接关闭

把客户端和服务器端的连接，或是主从节点间的连接关闭。

网络连接关闭造成的直接影响：就是业务程序无法读写 Redis，或者是主从节点全量同步失败，需要重新执行。

#### 5.2 命令数据丢失

主节点上的复制积压缓冲区属于环形缓冲区，一旦发生溢出，新写入的命令数据就会覆盖旧的命令数据，导致旧命令数据的丢失，进而导致主从节点重新进行全量复制。

### 5.3 缓冲区溢出的原因

- 命令数据发送过快过大；

- 命令数据处理较慢；
- 缓冲区空间过小。

### 5.4 缓冲区溢出的解决方案

- 针对命令数据发送过快过大的问题，对于普通客户端来说可以避免 bigkey，而对于复制缓冲区来说，就是避免过大的 RDB 文件。

- 针对命令数据处理较慢的问题，解决方案就是减少 Redis 主线程上的阻塞操作，例如使用异步的删除操作。

- 针对缓冲区空间过小的问题，解决方案就是使用 client-output-buffer-limit 配置项设置合理的输出缓冲区、复制缓冲区和复制积压缓冲区大小。当然，我们不要忘了，输入缓冲区的大小默认是固定的，我们无法通过配置来修改它，除非直接去修改 Redis 源码。



学习笔记来源于公众号「悟空聊架构」。

