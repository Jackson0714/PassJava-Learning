# 如何使用 Redis 缓存

## 一、计算机系统的缓存

计算机系统中的三层存储结构，以及它们各自的常用容量和访问性能：

<img src="http://cdn.jayh.club/uPic/ac80f6e1714f3e1e8eabcfd8da3d689c.jpg" style="zoom: 25%;" />

计算机系统中，默认有两种缓存：

- CPU 里面的末级缓存，即 LLC，用来缓存内存中的数据，避免每次从内存中存取数据；

- 内存中的高速页缓存，即 page cache，用来缓存磁盘中的数据，避免每次从磁盘中存取数据。

## 二、Redis 缓存

### 2.1 Redis 对缓存操作的两种情况

**缓存命中**：Redis 中有相应数据，就直接读取 Redis，性能非常快。

**缓存缺失**：Redis 中没有保存相应数据，就从后端数据库中读取数据，性能就会变慢。而且，一旦发生缓存缺失，为了让后续请求能从缓存中读取到数据，我们需要把缺失的数据写入 Redis，这个过程叫作缓存更新。

<img src="http://cdn.jayh.club/uPic/6b0b489ec0c1c5049c8df84d77fa243d.jpg" style="zoom:25%;" />

### 2.2 旁路缓存

我们也把 Redis 称为旁路缓存，也就是说，读取缓存、读取数据库和更新缓存的操作都需要在应用程序中来完成。

### 2.3 缓存的类型

按照 Redis 缓存是否接受写请求，我们可以把它分成`只读缓存`和`读写缓存`。

### 2.4 只读缓存

假设业务应用要修改数据 A，此时，数据 A 在 Redis 中也缓存了，那么，应用会先直接在数据库里修改 A，并把 Redis 中的 A 删除。等到应用需要读取数据 A 时，会发生缓存缺失，此时，应用从数据库中读取 A，并写入 Redis，以便后续请求从缓存中直接读取，如下图所示：

<img src="http://cdn.jayh.club/uPic/464ea24a098c87b9d292cf61a2b2fecd.jpg" style="zoom:25%;" />

好处：

- 最新的数据都在数据库

### 2.5 读写缓存

对于读写缓存来说，除了读请求会发送到缓存进行处理（直接在缓存中查询数据是否存在)，所有的写请求也会发送到缓存，在缓存中直接对数据进行增删改操作。此时，得益于 Redis 的高性能访问特性，数据的增删改操作可以在缓存中快速完成，处理结果也会快速返回给业务应用，这就可以提升业务应用的响应速度。

和只读缓存不一样的是，在使用读写缓存时，最新的数据是在 Redis 中，而 Redis 是内存数据库，一旦出现掉电或宕机，内存中的数据就会丢失。

根据业务应用对数据可靠性和缓存性能的不同要求，会有`同步直写`和`异步写回`两种策略。其中，同步直写策略优先保证数据可靠性，而异步写回策略优先提供快速响应。

<img src="http://cdn.jayh.club/uPic/009d055bb91d42c28b9316c649f87f66.jpg" style="zoom:25%;" />

如果需要对写请求进行加速，我们选择读写缓存；

如果写请求很少，或者是只需要提升读请求的响应速度的话，我们选择只读缓存。

## 小测验

按照惯例，我给你提一个小问题。这节课，我提到了 Redis 只读缓存和使用直写策略的读写缓存，这两种缓存都会把数据同步写到后端数据库中，你觉得，它们有什么区别吗？

答：

- 区别 1、 一个是删除，一个是更新：

只读缓存会删除 Redis 中的数据和更新数据库中的数据。

而直写策略是更新 Redis 和更新数据库中的数据。

- 区别 2、一致性保证问题

只读缓存中，可以快速将 Redis key 失效，缓存和数据库一致性很容易被保证。

而只写策略中，需要保证数据库和缓存的一致性。

- 区别 3、性能问题

只读缓存中，数据再次被读取时，因为 Redis 中缺失 key，所以需要先从数据库中读到后，放到缓存中，影响性能。

而只写策略中，数据直接从 Redis 中读取，性能较好。

