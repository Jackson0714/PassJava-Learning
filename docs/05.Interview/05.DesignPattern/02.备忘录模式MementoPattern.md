# 备忘录模式 Memento Design Pattern

[toc]

## 概述

看似很简单的一种模式，背后却蕴藏着丰富的架构设计思想。

备忘录，也就是说某个时间点存储一份备份，当要恢复那个时间点数据时，将备忘录里面的数据恢复就好了。

备忘录模式是一种设计思想，没有具体的编码要求，所以在不同的项目中，也会有不同的设计，理解其思想并结合业务实现就可以了。

## 生活中的例子

植物大战僵尸游戏，有个离线玩法，就是不联网可以单机玩，本地保存游戏进度，比如获得了哪几种新的植物，过了多少关卡，都会记录到本地，一旦游戏联网，就会检查本地进度和服务器的进度是否一致，如果本地较新，就会将本地数据覆盖服务器的数据。那么本地存储数据的方式就是备忘录。

## 企业项目场景

假设项目中有个内存队列用来对消息进行存储，生产者将消息放到消息队列，消费者将消息取出来消费，让生产者和消费者达到异步解耦。

非阻塞队列可能会把内存写爆，导致 JVM OOM。

如果出现了消息积压导致消息队列满了怎么办？

消息积压的原因：

- 消费者出故障了，消费速度慢或者不能消费。
- 生产者短时间内产生了大量消息。

这个时候就可以将消息存储到数据库，等消息队列有空间存储后，再将数据库中的消息转存到消息队列。数据库作为一个离线存储的工具，也可以称作备忘录。

类似数据库存储消息，我们也可以采用其他方式来存储，比如用 Redis，JVM Ehcache，磁盘，ES 等等。

## 说下实现细节

每次存放消息时，检查消息队列是否满了，如果满了，则设置消息队列的状态：`已离线`。

如果已离线，则将消息转存到数据库。

当检测到消息队列没有满时：

- 启动一个后台任务，小批量从数据库获取消息，然后转存到消息队列。
- 然后将数据库中的这部分消息批量删掉。
- 当数据库没有消息时，将消息队列的状态改为`已上线`。
- 新的消息都会被存到消息队列，就不放数据库了。

## 中间件使用备忘录的场景

 Redis 

- 比如 Redis 的定期备份 RDB 到服务器。当线上出现问题，想要快速恢复到某个稳定数据的版本时，可以使用备份的 RDB 文件快速恢复。

- 主从首次复制利用客户端缓冲区增量更新数据。

- 主从重连后，利用复制积压缓冲区增量更新数据。

MySQL
- 主从备份





